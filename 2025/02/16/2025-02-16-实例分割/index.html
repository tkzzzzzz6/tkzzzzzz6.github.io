<!DOCTYPE html>
<html lang="zh">
  <head>
    
    <meta charset="UTF-8">
    <title>实例分割 - TK的小站</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:site_name" content="TK的小站">
    <meta property="og:title" content="实例分割"/>
    
    <style>body:before{ content: ''; background-image: url(https://api.paugram.com/wallpaper?source=gh) }</style>
    
<meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="TK的小站" type="application/atom+xml">
</head>

  <body>
    <header>
    <div class="head-title">
        <h4>TK的小站</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a href>分类</a>
            <div class="sub-menu">
                
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
            <a href="/friends">朋友们</a>
        
            <a href="/tools">工具推荐</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>实例分割</h2>
            <div class="post-meta">
                <time class="date">2025.02.16</time>
            
            </div>
        </section>
        <article class="post-content">
        
            <blockquote>这篇文章上次修改于 228 天前，可能其部分内容已经发生变化，如有疑问可询问作者。</blockquote>
        
            <h1 id="实例分割（Instance-Segmentation）"><a href="#实例分割（Instance-Segmentation）" class="headerlink" title="实例分割（Instance Segmentation）"></a><strong>实例分割（Instance Segmentation）</strong></h1><h2 id="定义"><a href="#定义" class="headerlink" title="** 定义**"></a>** 定义**</h2><p>实例分割是目标检测和语义分割的结合，旨在精确识别图像中的每个目标对象，并区分同一类别中的不同实例。例如，在一张包含多个人的图像中，实例分割不仅需要识别出“人”这一类别，还需要将每个人单独区分开来，为每个人生成独立的分割掩码（Mask）。</p>
<p>实例分割通过融合目标检测和语义分割的结果来实现这一目标。具体而言，它利用目标检测提供的目标类别和位置信息（如边界框和置信度），从语义分割的结果中提取出对应目标的像素级掩码。简而言之，实例分割的任务是将同一类别中的具体对象（即实例）分别分割出来。</p>
<p>举个例子,近年来，随着自动驾驶等领域的快速发展，实例分割任务受到了广泛关注。自动驾驶场景中，精确区分和分割道路上的行人、车辆等目标对于环境感知和决策至关重要。此外，一些实例分割任务还会输出检测结果（如边界框），以提供更全面的目标描述。</p>
<p>对实例分割、语义分割和目标检测混合任务感兴趣的读者，可以参考 CVPR 2019 的论文《Hybrid Task Cascade》（HTC），该研究提出了一种混合任务级联框架，能够同时处理这三种任务，为多任务学习提供了新的思路。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a><strong>特点</strong></h2><ul>
<li>能够精确地定位和区分同一类别的不同实例。</li>
<li>计算成本较高，因为需要对每个目标实例进行单独检测和分类。</li>
</ul>
<h2 id="应用"><a href="#应用" class="headerlink" title="** 应用**"></a>** 应用**</h2><p>实例分割在以下领域有重要应用：</p>
<ul>
<li><strong>自动驾驶</strong>：用于检测和分割车辆、行人。</li>
<li><strong>医学成像</strong>：用于检测组织和病理的特定边界。</li>
<li><strong>机器人视觉</strong>：用于识别和隔离目标物体。</li>
</ul>
<h2 id="常见模型"><a href="#常见模型" class="headerlink" title="** 常见模型**"></a>** 常见模型**</h2><h3 id="Mask-R-CNN"><a href="#Mask-R-CNN" class="headerlink" title="Mask R-CNN"></a><strong>Mask R-CNN</strong></h3><ul>
<li><strong>优点</strong>：能够同时进行目标检测和语义分割，具有较好的性能。</li>
<li><strong>缺点</strong>：模型参数多，训练和推理速度较慢；大目标的边缘分割较为粗糙。</li>
</ul>
<h4 id="提出初衷"><a href="#提出初衷" class="headerlink" title="提出初衷"></a>提出初衷</h4><p>Mask R-CNN 是 2017 年发表的文章，一作是何恺明大神，没错就是那个男人，除此之外还有 Faster R-CNN 系列的大神 Ross Girshick，可以说是强强联合。该论文也获得了 ICCV 2017 的最佳论文奖（Marr Prize）。并且该网络提出后，又霸榜了 MS COCO 的各项任务，包括目标检测、实例分割以及人体关键点检测任务。Mask R-CNN 的结构很简洁而且很灵活效果又很好（仅仅是在 Faster R-CNN 的基础上根据需求加入一些新的分支）。<br>Mask R-CNN 的提出初衷是为了实现高效且精确的实例分割任务，同时继承 Faster R-CNN 在目标检测方面的优势。具体而言，Mask R-CNN 的核心动机是将目标检测与语义分割相结合，既能检测图像中的目标并定位其边界框，又能为每个目标生成精确的像素级分割掩码。此外，Mask R-CNN 通过引入 RoI Align 技术，解决了 Faster R-CNN 中 RoI Pooling 导致的特征图与原始图像区域对齐不精确的问题，显著提高了分割掩码的精度。Mask R-CNN 在 Faster R-CNN 的基础上增加了全卷积网络（FCN）分支，用于预测每个感兴趣区域（RoI）的分割掩码，这种设计不仅简单高效，且只增加了较小的计算开销。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407201646JSjbb2yMTo66D3xSrKfcVwQCnSc.png" alt="1740407201646JSjbb2yMTo66D3xSrKfcVwQCnSc.png"><br>它还具备良好的多任务扩展性，能够轻松扩展到其他任务（如人体关键点检测），成为一种通用的视觉框架。通过为每个类别预测独立的二元掩码，Mask R-CNN 能够更好地提取目标的空间布局信息，从而生成更精确的分割掩码，并在 COCO 等数据集上取得了显著优于当时其他模型的性能。总之，Mask R-CNN 的提出填补了目标检测和语义分割之间的空白，提供了一种高精度、高效率的实例分割解决方案。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407212685Z2kFbwjzroUn5Xx4JNDcueDNnK2.png" alt="1740407212685Z2kFbwjzroUn5Xx4JNDcueDNnK2.png"><br>Mask R-CNN 的提出初衷是为了实现高效且精确的实例分割任务，同时继承 Faster R-CNN 在目标检测方面的优势。具体动机和背景如下：</p>
<ol>
<li><strong>结合目标检测与语义分割</strong><br>在 Mask R-CNN 提出之前，目标检测（如 Faster R-CNN）和语义分割（如 FCN）是两个独立的领域。Mask R-CNN 的核心动机是将两者结合起来，既能够检测图像中的目标并定位其边界框，还能为每个目标生成精确的像素级分割掩码。</li>
<li><strong>解决像素级对齐问题</strong><br>Faster R-CNN 在处理像素级任务时存在局限性，尤其是其 RoI Pooling 操作会导致特征图与原始图像区域的对齐不精确。Mask R-CNN 通过引入 RoI Align 技术，解决了这一问题，显著提高了分割掩码的精度。</li>
<li><strong>简单高效的架构设计</strong><br>Mask R-CNN 在 Faster R-CNN 的基础上，增加了一个全卷积网络（FCN）分支，用于预测每个感兴趣区域（RoI）的分割掩码。这种设计不仅简单高效，而且只增加了较小的计算开销。</li>
<li><strong>多任务学习的扩展性</strong><br>Mask R-CNN 不仅适用于实例分割，还可以轻松扩展到其他任务，如人体关键点检测。这种多任务扩展性使其成为一种通用的视觉框架。</li>
<li><strong>提升实例分割精度</strong><br>通过为每个类别预测独立的二元掩码，Mask R-CNN 能够更好地提取目标的空间布局信息，从而生成更精确的分割掩码。这一改进使其在 COCO 等数据集上取得了显著优于当时其他模型的性能。</li>
</ol>
<h4 id="网络结构"><a href="#网络结构" class="headerlink" title="网络结构"></a>网络结构</h4><p>Mask R-CNN 的结构也很简单，就是在通过 RoIAlign（在原 Faster R-CNN 中是 RoIPool）得到的 RoI 基础上并行添加一个 Mask 分支（小型的 FCN）。见下图，之前 Faster R-CNN 是在 RoI 基础上接上一个 Fast R-CNN 检测头，即图中 class, box 分支，现在又并行了一个 Mask 分支。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407241647NcMPbytf4o9G40xNM1UcgSMbn4f.png" alt="1740407241647NcMPbytf4o9G40xNM1UcgSMbn4f.png"></p>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407249647WI67bCnZrobIRSx9aWhclwDEnlj.png" alt="1740407249647WI67bCnZrobIRSx9aWhclwDEnlj.png"><br>注意带和不带 FPN 结构的 Mask R-CNN 在 Mask 分支上略有不同，对于带有 FPN 结构的 Mask R-CNN 它的 class、box 分支和 Mask 分支并不是共用一个 RoIAlign。在训练过程中，对于 class, box 分支 RoIAlign 将 RPN（Region Proposal Network）得到的 Proposals 池化到 7x7 大小，而对于 Mask 分支 RoIAlign 将 Proposals 池化到 14x14 大小。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407261695EyHvbUkC0ouDKnxVfEGcm0iKnKd.png" alt="1740407261695EyHvbUkC0ouDKnxVfEGcm0iKnKd.png"></p>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407267643MVthb679voUnaYxQpPBcDtJCnIf.png" alt="1740407267643MVthb679voUnaYxQpPBcDtJCnIf.png"></p>
<blockquote>
<p>Q:<strong>Mask R-CNN 中的 RoI Align 技术是如何解决 Faster R-CNN 中 RoI Pooling 导致的特征图与原始图像区域对齐不精确的问题的呢？</strong></p>
</blockquote>
<h4 id="模型代码"><a href="#模型代码" class="headerlink" title="模型代码"></a>模型代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">"""</span><br><span class="hljs-string">Model definitions</span><br><span class="hljs-string"></span><br><span class="hljs-string">"""</span><br><span class="hljs-keyword">from</span> torch.autograd <span class="hljs-keyword">import</span> Variable<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> math<br><br><span class="hljs-keyword">from</span> model.resnet <span class="hljs-keyword">import</span> resnet50<br><span class="hljs-keyword">from</span> model.rpn <span class="hljs-keyword">import</span> RPN<br><span class="hljs-comment">#from model.lib.roi_align.roi_align.roi_align import RoIAlign</span><br><span class="hljs-keyword">from</span> model.lib.roi_align.roi_align.crop_and_resize <span class="hljs-keyword">import</span> CropAndResize<br><span class="hljs-keyword">from</span> model.lib.bbox.generate_anchors <span class="hljs-keyword">import</span> generate_pyramid_anchors<br><span class="hljs-keyword">from</span> model.lib.bbox.nms <span class="hljs-keyword">import</span> torch_nms <span class="hljs-keyword">as</span> nms<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">log2_graph</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-string">"""Implementatin of Log2. pytorch doesn't have a native implemenation."""</span><br>    <span class="hljs-keyword">return</span> torch.div(torch.log(x), math.log(<span class="hljs-number">2.</span>))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ROIAlign</span>(<span class="hljs-params">feature_maps, rois, config, pool_size, mode=<span class="hljs-string">'bilinear'</span></span>):<br>    <span class="hljs-string">"""Implements ROI Align on the features.</span><br><span class="hljs-string">    Params:</span><br><span class="hljs-string">    - pool_shape: [height, width] of the output pooled regions. Usually [7, 7]</span><br><span class="hljs-string">    - image_shape: [height, width, chanells]. Shape of input image in pixels</span><br><span class="hljs-string">    Inputs:</span><br><span class="hljs-string">    - boxes: [batch, num_boxes, (x1, y1, x2, y2)] in normalized</span><br><span class="hljs-string">             coordinates. Possibly padded with zeros if not enough</span><br><span class="hljs-string">             boxes to fill the array.</span><br><span class="hljs-string">    - Feature maps: List of feature maps from different levels of the pyramid.</span><br><span class="hljs-string">                    Each is [batch, channels, height, width]</span><br><span class="hljs-string">    Output:</span><br><span class="hljs-string">    Pooled regions in the shape: [batch, num_boxes, height, width, channels].</span><br><span class="hljs-string">    The width and height are those specific in the pool_shape in the layer</span><br><span class="hljs-string">    constructor.</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    [  x2-x1             x1 + x2 - W + 1  ]</span><br><span class="hljs-string">    [  -----      0      ---------------  ]</span><br><span class="hljs-string">    [  W - 1                  W - 1       ]</span><br><span class="hljs-string">    [                                     ]</span><br><span class="hljs-string">    [           y2-y1    y1 + y2 - H + 1  ]</span><br><span class="hljs-string">    [    0      -----    ---------------  ]</span><br><span class="hljs-string">    [           H - 1         H - 1      ]</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-comment">#feature_maps= [P2, P3, P4, P5]</span><br>    rois = rois.detach()<br>    crop_resize = CropAndResize(pool_size, pool_size, <span class="hljs-number">0</span>)<br><br>    roi_number = rois.size()[<span class="hljs-number">1</span>]<br><br>    pooled = rois.data.new(<br>            config.IMAGES_PER_GPU*rois.size(<br>            <span class="hljs-number">1</span>), <span class="hljs-number">256</span>, pool_size, pool_size).zero_()<br><br>    rois = rois.view(<br>            config.IMAGES_PER_GPU*rois.size(<span class="hljs-number">1</span>),<br>            <span class="hljs-number">4</span>)<br><br>    <span class="hljs-comment"># Loop through levels and apply ROI pooling to each. P2 to P5.</span><br>    x_1 = rois[:, <span class="hljs-number">0</span>]<br>    y_1 = rois[:, <span class="hljs-number">1</span>]<br>    x_2 = rois[:, <span class="hljs-number">2</span>]<br>    y_2 = rois[:, <span class="hljs-number">3</span>]<br><br>    roi_level = log2_graph(<br>        torch.div(torch.sqrt((y_2 - y_1) * (x_2 - x_1)), <span class="hljs-number">224.0</span>))<br><br>    roi_level = torch.clamp(torch.clamp(<br>        torch.add(torch.<span class="hljs-built_in">round</span>(roi_level), <span class="hljs-number">4</span>), <span class="hljs-built_in">min</span>=<span class="hljs-number">2</span>), <span class="hljs-built_in">max</span>=<span class="hljs-number">5</span>)<br><br>    <span class="hljs-comment"># P2 is 256x256, P3 is 128x128, P4 is 64x64, P5 is 32x32</span><br>    <span class="hljs-comment"># P2 is 4, P3 is 8, P4 is 16, P5 is 32</span><br>    <span class="hljs-keyword">for</span> i, level <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, <span class="hljs-number">6</span>)):<br><br>        scaling_ratio = <span class="hljs-number">2</span>**level<br><br>        height = <span class="hljs-built_in">float</span>(config.IMAGE_MAX_DIM)/ scaling_ratio<br>        width = <span class="hljs-built_in">float</span>(config.IMAGE_MAX_DIM) / scaling_ratio<br><br>        ixx = torch.eq(roi_level, level)<br><br>        box_indices = ixx.view(-<span class="hljs-number">1</span>).<span class="hljs-built_in">int</span>() * <span class="hljs-number">0</span><br>        ix = torch.unsqueeze(ixx, <span class="hljs-number">1</span>)<br>        level_boxes = torch.masked_select(rois, ix)<br>        <span class="hljs-keyword">if</span> level_boxes.size()[<span class="hljs-number">0</span>] == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">continue</span><br>        level_boxes = level_boxes.view(-<span class="hljs-number">1</span>, <span class="hljs-number">4</span>)<br><br>        crops = crop_resize(feature_maps[i], torch.div(<br>                level_boxes, <span class="hljs-built_in">float</span>(config.IMAGE_MAX_DIM)<br>                )[:, [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]], box_indices)<br><br>        indices_pooled = ixx.nonzero()[:, <span class="hljs-number">0</span>]<br>        pooled[indices_pooled.data, :, :, :] = crops.data<br><br>    pooled = pooled.view(config.IMAGES_PER_GPU, roi_number,<br>               <span class="hljs-number">256</span>, pool_size, pool_size)<br>    pooled = Variable(pooled).cuda()<br>    <span class="hljs-keyword">return</span> pooled<br><br><br><span class="hljs-comment"># ---------------------------------------------------------------</span><br><span class="hljs-comment"># Heads</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MaskHead</span>(nn.Module):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config</span>):<br>        <span class="hljs-built_in">super</span>(MaskHead, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.config = config<br>        <span class="hljs-variable language_">self</span>.num_classes = config.NUM_CLASSES<br>        <span class="hljs-comment">#self.crop_size = config.mask_crop_size</span><br><br>        <span class="hljs-comment">#self.roi_align = RoIAlign(self.crop_size, self.crop_size)</span><br>        <span class="hljs-variable language_">self</span>.conv1 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.bn1 = nn.BatchNorm2d(<span class="hljs-number">256</span>)<br>        <span class="hljs-variable language_">self</span>.conv2 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.bn2 = nn.BatchNorm2d(<span class="hljs-number">256</span>)<br>        <span class="hljs-variable language_">self</span>.conv3 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.bn3 = nn.BatchNorm2d(<span class="hljs-number">256</span>)<br>        <span class="hljs-variable language_">self</span>.conv4 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.bn4 = nn.BatchNorm2d(<span class="hljs-number">256</span>)<br><br>        <span class="hljs-variable language_">self</span>.deconv = nn.ConvTranspose2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">4</span>, padding=<span class="hljs-number">1</span>, stride=<span class="hljs-number">2</span>, bias=<span class="hljs-literal">False</span>)<br>        <span class="hljs-variable language_">self</span>.mask = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-variable language_">self</span>.num_classes, kernel_size=<span class="hljs-number">1</span>, padding=<span class="hljs-number">0</span>, stride=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, rpn_rois</span>):<br>        <span class="hljs-comment">#x = self.roi_align(x, rpn_rois)</span><br>        x = ROIAlign(x, rpn_rois, <span class="hljs-variable language_">self</span>.config, <span class="hljs-variable language_">self</span>.config.MASK_POOL_SIZE)<br><br>        roi_number = x.size()[<span class="hljs-number">1</span>]<br><br>        <span class="hljs-comment"># merge batch and roi number together</span><br>        x = x.view(<span class="hljs-variable language_">self</span>.config.IMAGES_PER_GPU * roi_number,<br>                   <span class="hljs-number">256</span>, <span class="hljs-variable language_">self</span>.config.MASK_POOL_SIZE,<br>                   <span class="hljs-variable language_">self</span>.config.MASK_POOL_SIZE)<br><br>        x = F.relu(<span class="hljs-variable language_">self</span>.bn1(<span class="hljs-variable language_">self</span>.conv1(x)), inplace=<span class="hljs-literal">True</span>)<br>        x = F.relu(<span class="hljs-variable language_">self</span>.bn2(<span class="hljs-variable language_">self</span>.conv2(x)), inplace=<span class="hljs-literal">True</span>)<br>        x = F.relu(<span class="hljs-variable language_">self</span>.bn3(<span class="hljs-variable language_">self</span>.conv3(x)), inplace=<span class="hljs-literal">True</span>)<br>        x = F.relu(<span class="hljs-variable language_">self</span>.bn4(<span class="hljs-variable language_">self</span>.conv4(x)), inplace=<span class="hljs-literal">True</span>)<br>        x = <span class="hljs-variable language_">self</span>.deconv(x)<br>        rcnn_mask_logits = <span class="hljs-variable language_">self</span>.mask(x)<br><br>        rcnn_mask_logits = rcnn_mask_logits.view(<span class="hljs-variable language_">self</span>.config.IMAGES_PER_GPU,<br>                                                 roi_number,<br>                                                 <span class="hljs-variable language_">self</span>.config.NUM_CLASSES,<br>                                                 <span class="hljs-variable language_">self</span>.config.MASK_POOL_SIZE * <span class="hljs-number">2</span>,<br>                                                 <span class="hljs-variable language_">self</span>.config.MASK_POOL_SIZE * <span class="hljs-number">2</span>)<br><br>        <span class="hljs-keyword">return</span> rcnn_mask_logits<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RCNNHead</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config</span>):<br>        <span class="hljs-built_in">super</span>(RCNNHead, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.config = config<br>        <span class="hljs-variable language_">self</span>.num_classes = config.NUM_CLASSES<br>        <span class="hljs-comment">#self.crop_size = config.rcnn_crop_size</span><br><br>        <span class="hljs-comment">#self.roi_align = RoIAlign(self.crop_size, self.crop_size)</span><br>        <span class="hljs-variable language_">self</span>.fc1 = nn.Linear(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>)<br>        <span class="hljs-variable language_">self</span>.fc2 = nn.Linear(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>)<br>        <span class="hljs-variable language_">self</span>.class_logits = nn.Linear(<span class="hljs-number">1024</span>, <span class="hljs-variable language_">self</span>.num_classes)<br>        <span class="hljs-variable language_">self</span>.bbox = nn.Linear(<span class="hljs-number">1024</span>, <span class="hljs-variable language_">self</span>.num_classes * <span class="hljs-number">4</span>)<br><br>        <span class="hljs-variable language_">self</span>.conv1 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">1024</span>, kernel_size=<span class="hljs-variable language_">self</span>.config.POOL_SIZE, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">0</span>)<br>        <span class="hljs-variable language_">self</span>.bn1 = nn.BatchNorm2d(<span class="hljs-number">1024</span>, eps=<span class="hljs-number">0.001</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, rpn_rois</span>):<br>        x = ROIAlign(x, rpn_rois, <span class="hljs-variable language_">self</span>.config, <span class="hljs-variable language_">self</span>.config.POOL_SIZE)<br>        roi_number = x.size()[<span class="hljs-number">1</span>]<br><br>        x = x.view(<span class="hljs-variable language_">self</span>.config.IMAGES_PER_GPU * roi_number,<br>                   <span class="hljs-number">256</span>, <span class="hljs-variable language_">self</span>.config.POOL_SIZE,<br>                   <span class="hljs-variable language_">self</span>.config.POOL_SIZE)<br>        <span class="hljs-comment">#print(x.shape)</span><br>        <span class="hljs-comment">#x = self.roi_align(x, rpn_rois, self.config, self.config.POOL_SIZE)</span><br>        <span class="hljs-comment">#x = crops.view(crops.size(0), -1)</span><br>        x = <span class="hljs-variable language_">self</span>.bn1(<span class="hljs-variable language_">self</span>.conv1(x))<br>        x = x.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>).contiguous().view(x.size(<span class="hljs-number">0</span>), -<span class="hljs-number">1</span>)<br>        x = F.relu(<span class="hljs-variable language_">self</span>.fc1(x), inplace=<span class="hljs-literal">True</span>)<br>        x = F.relu(<span class="hljs-variable language_">self</span>.fc2(x), inplace=<span class="hljs-literal">True</span>)<br>        <span class="hljs-comment">#x = F.dropout(x, 0.5, training=self.training)</span><br>        rcnn_class_logits = <span class="hljs-variable language_">self</span>.class_logits(x)<br>        rcnn_probs = F.softmax(rcnn_class_logits, dim=-<span class="hljs-number">1</span>)<br><br>        rcnn_bbox = <span class="hljs-variable language_">self</span>.bbox(x)<br><br>        rcnn_class_logits = rcnn_class_logits.view(<span class="hljs-variable language_">self</span>.config.IMAGES_PER_GPU,<br>                                                   roi_number,<br>                                                   rcnn_class_logits.size()[-<span class="hljs-number">1</span>])<br><br>        rcnn_probs = rcnn_probs.view(<span class="hljs-variable language_">self</span>.config.IMAGES_PER_GPU,<br>                                     roi_number,<br>                                     rcnn_probs.size()[-<span class="hljs-number">1</span>])<br><br>        rcnn_bbox = rcnn_bbox.view(<span class="hljs-variable language_">self</span>.config.IMAGES_PER_GPU,<br>                                   roi_number,<br>                                   <span class="hljs-variable language_">self</span>.config.NUM_CLASSES,<br>                                   <span class="hljs-number">4</span>)<br><br>        <span class="hljs-keyword">return</span> rcnn_class_logits, rcnn_probs, rcnn_bbox<br><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ---------------------------------------------------------------</span><br><span class="hljs-comment"># Mask R-CNN</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MaskRCNN</span>(nn.Module):<br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    Mask R-CNN model</span><br><span class="hljs-string">    """</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config</span>):<br>        <span class="hljs-built_in">super</span>(MaskRCNN, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.config = config<br>        <span class="hljs-variable language_">self</span>.__mode = <span class="hljs-string">'train'</span><br>        feature_channels = <span class="hljs-number">128</span><br>        <span class="hljs-comment"># define modules (set of layers)</span><br><span class="hljs-comment">#        self.feature_net = FeatureNet(cfg, 3, feature_channels)</span><br>        <span class="hljs-variable language_">self</span>.feature_net = resnet50().cuda()<br>        <span class="hljs-comment">#self.rpn_head = RpnMultiHead(cfg,feature_channels)</span><br>        <span class="hljs-variable language_">self</span>.rpn = RPN(<span class="hljs-number">256</span>, <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.config.RPN_ANCHOR_RATIOS),<br>                             <span class="hljs-variable language_">self</span>.config.RPN_ANCHOR_STRIDE)<br>        <span class="hljs-comment">#self.rcnn_crop = CropRoi(cfg, cfg.rcnn_crop_size)</span><br>        <span class="hljs-variable language_">self</span>.rcnn_head = RCNNHead(config)<br>        <span class="hljs-comment">#self.mask_crop = CropRoi(cfg, cfg.mask_crop_size)</span><br>        <span class="hljs-variable language_">self</span>.mask_head = MaskHead(config)<br><br>        <span class="hljs-variable language_">self</span>.anchors = generate_pyramid_anchors(<span class="hljs-variable language_">self</span>.config.RPN_ANCHOR_SCALES,<br>                                                <span class="hljs-variable language_">self</span>.config.RPN_ANCHOR_RATIOS,<br>                                                <span class="hljs-variable language_">self</span>.config.BACKBONE_SHAPES,<br>                                                <span class="hljs-variable language_">self</span>.config.BACKBONE_STRIDES,<br>                                                <span class="hljs-variable language_">self</span>.config.RPN_ANCHOR_STRIDE)<br>        <span class="hljs-variable language_">self</span>.anchors = <span class="hljs-variable language_">self</span>.anchors.astype(np.float32)<br>        <span class="hljs-variable language_">self</span>.proposal_count = <span class="hljs-variable language_">self</span>.config.POST_NMS_ROIS_TRAINING<br>        <span class="hljs-comment"># FPN</span><br>        <span class="hljs-variable language_">self</span>.fpn_c5p5 = nn.Conv2d(<br>            <span class="hljs-number">512</span> * <span class="hljs-number">4</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">0</span>)<br>        <span class="hljs-variable language_">self</span>.fpn_c4p4 = nn.Conv2d(<br>            <span class="hljs-number">256</span> * <span class="hljs-number">4</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">0</span>)<br>        <span class="hljs-variable language_">self</span>.fpn_c3p3 = nn.Conv2d(<br>            <span class="hljs-number">128</span> * <span class="hljs-number">4</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">0</span>)<br>        <span class="hljs-variable language_">self</span>.fpn_c2p2 = nn.Conv2d(<br>            <span class="hljs-number">64</span> * <span class="hljs-number">4</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>,  padding=<span class="hljs-number">0</span>)<br><br>        <span class="hljs-variable language_">self</span>.fpn_p2 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.fpn_p3 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.fpn_p4 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.fpn_p5 = nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span>)<br><br>        <span class="hljs-variable language_">self</span>.scale_ratios = [<span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>]<br>        <span class="hljs-variable language_">self</span>.fpn_p6 = nn.MaxPool2d(<br>            kernel_size=<span class="hljs-number">1</span>, stride=<span class="hljs-number">2</span>, padding=<span class="hljs-number">0</span>, ceil_mode=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-comment"># Extract features</span><br>        C1, C2, C3, C4, C5 = <span class="hljs-variable language_">self</span>.feature_net(x)<br>        P5 = <span class="hljs-variable language_">self</span>.fpn_c5p5(C5)<br>        P4 = <span class="hljs-variable language_">self</span>.fpn_c4p4(C4) + F.upsample(P5,<br>                                            scale_factor=<span class="hljs-number">2</span>, mode=<span class="hljs-string">'bilinear'</span>)<br>        P3 = <span class="hljs-variable language_">self</span>.fpn_c3p3(C3) + F.upsample(P4,<br>                                            scale_factor=<span class="hljs-number">2</span>, mode=<span class="hljs-string">'bilinear'</span>)<br>        P2 = <span class="hljs-variable language_">self</span>.fpn_c2p2(C2) + F.upsample(P3,<br>                                            scale_factor=<span class="hljs-number">2</span>, mode=<span class="hljs-string">'bilinear'</span>)<br><br>        <span class="hljs-comment"># Attach 3x3 conv to all P layers to get the final feature maps.</span><br>        <span class="hljs-comment"># P2 is 256, P3 is 128, P4 is 64, P5 is 32</span><br>        P2 = <span class="hljs-variable language_">self</span>.fpn_p2(P2)<br>        P3 = <span class="hljs-variable language_">self</span>.fpn_p3(P3)<br>        P4 = <span class="hljs-variable language_">self</span>.fpn_p4(P4)<br>        P5 = <span class="hljs-variable language_">self</span>.fpn_p5(P5)<br>        <span class="hljs-comment"># P6 is used for the 5th anchor scale in RPN. Generated by</span><br>        <span class="hljs-comment"># subsampling from P5 with stride of 2.</span><br>        P6 = <span class="hljs-variable language_">self</span>.fpn_p6(P5)<br><br>        <span class="hljs-comment"># Note that P6 is used in RPN, but not in the classifier heads.</span><br>        rpn_feature_maps = [P2, P3, P4, P5, P6]<br><br>        <span class="hljs-variable language_">self</span>.mrcnn_feature_maps = [P2, P3, P4, P5]<br><br>        rpn_class_logits_outputs = []<br>        rpn_class_outputs = []<br>        rpn_bbox_outputs = []<br>        <span class="hljs-comment"># RPN proposals</span><br>        <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> rpn_feature_maps:<br>            rpn_class_logits, rpn_probs, rpn_bbox = <span class="hljs-variable language_">self</span>.rpn(feature)<br>            rpn_class_logits_outputs.append(rpn_class_logits)<br>            rpn_class_outputs.append(rpn_probs)<br>            rpn_bbox_outputs.append(rpn_bbox)<br><br>        rpn_class_logits = torch.cat(rpn_class_logits_outputs, dim=<span class="hljs-number">1</span>)<br>        rpn_class = torch.cat(rpn_class_outputs, dim=<span class="hljs-number">1</span>)<br>        rpn_bbox = torch.cat(rpn_bbox_outputs, dim=<span class="hljs-number">1</span>)<br><br>        rpn_proposals = <span class="hljs-variable language_">self</span>.proposal_layer(rpn_class, rpn_bbox)<br><br>        <span class="hljs-comment"># RCNN proposals</span><br>        rcnn_class_logits, rcnn_class, rcnn_bbox = <span class="hljs-variable language_">self</span>.rcnn_head(<span class="hljs-variable language_">self</span>.mrcnn_feature_maps, rpn_proposals)<br>        rcnn_mask_logits = <span class="hljs-variable language_">self</span>.mask_head(<span class="hljs-variable language_">self</span>.mrcnn_feature_maps, rpn_proposals)<br>        <span class="hljs-comment"># &lt;todo&gt; mask nms</span><br><br>        <span class="hljs-keyword">return</span> [rpn_class_logits, rpn_class, rpn_bbox, rpn_proposals,<br>                rcnn_class_logits, rcnn_class, rcnn_bbox,<br>                rcnn_mask_logits]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">proposal_layer</span>(<span class="hljs-params">self, rpn_class, rpn_bbox</span>):<br>        <span class="hljs-comment"># handling proposals</span><br>        scores = rpn_class[:, :, <span class="hljs-number">1</span>]<br>        <span class="hljs-comment">#print(scores.shape)</span><br>        <span class="hljs-comment"># Box deltas [batch, num_rois, 4]</span><br>        deltas_mul = Variable(torch.from_numpy(np.reshape(<br>            <span class="hljs-variable language_">self</span>.config.RPN_BBOX_STD_DEV, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>]).astype(np.float32))).cuda()<br>        deltas = rpn_bbox * deltas_mul<br><br>        pre_nms_limit = <span class="hljs-built_in">min</span>(<span class="hljs-number">6000</span>, <span class="hljs-variable language_">self</span>.anchors.shape[<span class="hljs-number">0</span>])<br><br>        scores, ix = torch.topk(scores, pre_nms_limit, dim=-<span class="hljs-number">1</span>,<br>                                largest=<span class="hljs-literal">True</span>, <span class="hljs-built_in">sorted</span>=<span class="hljs-literal">True</span>)<br><br>        ix = torch.unsqueeze(ix, <span class="hljs-number">2</span>)<br>        ix = torch.cat([ix, ix, ix, ix], dim=<span class="hljs-number">2</span>)<br>        deltas = torch.gather(deltas, <span class="hljs-number">1</span>, ix)<br><br>        _anchors = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.config.IMAGES_PER_GPU):<br>            anchors = Variable(torch.from_numpy(<br>                <span class="hljs-variable language_">self</span>.anchors.astype(np.float32))).cuda()<br>            _anchors.append(anchors)<br>        anchors = torch.stack(_anchors, <span class="hljs-number">0</span>)<br><br>        pre_nms_anchors = torch.gather(anchors, <span class="hljs-number">1</span>, ix)<br>        refined_anchors = apply_box_deltas_graph(pre_nms_anchors, deltas)<br><br>        <span class="hljs-comment"># Clip to image boundaries. [batch, N, (y1, x1, y2, x2)]</span><br>        height, width = <span class="hljs-variable language_">self</span>.config.IMAGE_SHAPE[:<span class="hljs-number">2</span>]<br>        window = np.array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, height, width]).astype(np.float32)<br>        window = Variable(torch.from_numpy(window)).cuda()<br><br>        refined_anchors_clipped = clip_boxes_graph(refined_anchors, window)<br><br>        refined_proposals = []<br>        scores = scores[:,:,<span class="hljs-literal">None</span>]<br>        <span class="hljs-comment">#print(scores.data.shape)</span><br>        <span class="hljs-comment">#print(refined_anchors_clipped.data.shape)</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.config.IMAGES_PER_GPU):<br>            indices = nms(<br>                torch.cat([refined_anchors_clipped.data[i], scores.data[i]], <span class="hljs-number">1</span>), <span class="hljs-number">0.7</span>)<br>            indices = indices[:<span class="hljs-variable language_">self</span>.proposal_count]<br>            indices = torch.stack([indices, indices, indices, indices], dim=<span class="hljs-number">1</span>)<br>            indices = Variable(indices).cuda()<br>            proposals = torch.gather(refined_anchors_clipped[i], <span class="hljs-number">0</span>, indices)<br>            padding = <span class="hljs-variable language_">self</span>.proposal_count - proposals.size()[<span class="hljs-number">0</span>]<br>            proposals = torch.cat(<br>                [proposals, Variable(torch.zeros([padding, <span class="hljs-number">4</span>])).cuda()], <span class="hljs-number">0</span>)<br>            refined_proposals.append(proposals)<br><br>        rpn_rois = torch.stack(refined_proposals, <span class="hljs-number">0</span>)<br><br>        <span class="hljs-keyword">return</span> rpn_rois<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_box_deltas_graph</span>(<span class="hljs-params">boxes, deltas</span>):<br>    <span class="hljs-string">"""Applies the given deltas to the given boxes.</span><br><span class="hljs-string">    boxes: [N, 4] where each row is y1, x1, y2, x2</span><br><span class="hljs-string">    deltas: [N, 4] where each row is [dy, dx, log(dh), log(dw)]</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-comment"># Convert to y, x, h, w</span><br>    height = boxes[:, :, <span class="hljs-number">2</span>] - boxes[:, :, <span class="hljs-number">0</span>]<br>    width = boxes[:, :, <span class="hljs-number">3</span>] - boxes[:, :, <span class="hljs-number">1</span>]<br>    center_y = boxes[:, :, <span class="hljs-number">0</span>] + <span class="hljs-number">0.5</span> * height<br>    center_x = boxes[:, :, <span class="hljs-number">1</span>] + <span class="hljs-number">0.5</span> * width<br>    <span class="hljs-comment"># Apply deltas</span><br>    center_y += deltas[:, :, <span class="hljs-number">0</span>] * height<br>    center_x += deltas[:, :, <span class="hljs-number">1</span>] * width<br>    height *= torch.exp(deltas[:, :, <span class="hljs-number">2</span>])<br>    width *= torch.exp(deltas[:, :, <span class="hljs-number">3</span>])<br>    <span class="hljs-comment"># Convert back to y1, x1, y2, x2</span><br>    y1 = center_y - <span class="hljs-number">0.5</span> * height<br>    x1 = center_x - <span class="hljs-number">0.5</span> * width<br>    y2 = y1 + height<br>    x2 = x1 + width<br>    result = [y1, x1, y2, x2]<br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">clip_boxes_graph</span>(<span class="hljs-params">boxes, window</span>):<br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    boxes: [N, 4] each row is y1, x1, y2, x2</span><br><span class="hljs-string">    window: [4] in the form y1, x1, y2, x2</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-comment"># Split corners</span><br>    wy1, wx1, wy2, wx2 = window<br>    y1, x1, y2, x2 = boxes<br>    <span class="hljs-comment"># Clip</span><br><br>    y1 = torch.<span class="hljs-built_in">max</span>(torch.<span class="hljs-built_in">min</span>(y1, wy2), wy1)<br>    x1 = torch.<span class="hljs-built_in">max</span>(torch.<span class="hljs-built_in">min</span>(x1, wx2), wx1)<br>    y2 = torch.<span class="hljs-built_in">max</span>(torch.<span class="hljs-built_in">min</span>(y2, wy2), wy1)<br>    x2 = torch.<span class="hljs-built_in">max</span>(torch.<span class="hljs-built_in">min</span>(x2, wx2), wx1)<br><br>    clipped = torch.stack([x1, y1, x2, y2], dim=<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">return</span> clipped<br></code></pre></td></tr></table></figure>

<h4 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h4><h5 id="项目"><a href="#项目" class="headerlink" title="项目"></a><strong>项目</strong></h5><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/JenifferWuUCLA/pulmonary-nodules-MaskRCNN/tree/master">JenifferWuUCLA/pulmonary-nodules-MaskRCNN: Mask R-CNN for Pulmonary Nodules Diagnosis, using TensorFlow 天池医疗 AI 大赛：Mask R-CNN 肺部结节智能检测（Segmentation + Classification）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/facebookresearch/maskrcnn-benchmark">facebookresearch/maskrcnn-benchmark: Fast, modular reference implementation of Instance Segmentation and Object Detection algorithms in PyTorch.</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/leon-liangwu/MaskYolo_Caffe?tab=readme-ov-file">leon-liangwu/MaskYolo_Caffe: YOLO V2 &amp; V3 , YOLO Combined with RCNN and MaskRCNN</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/TannerGilbert/MaskRCNN-Object-Detection-and-Segmentation">TannerGilbert/MaskRCNN-Object-Detection-and-Segmentation: Train your own custom MaskRCNN Object Detection and Instance Segmentation model.</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/CharlesShang/FastMaskRCNN">CharlesShang/FastMaskRCNN: Mask RCNN in TensorFlow</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/buseyaren/installation-guide-of-maskrcnn?tab=readme-ov-file">buseyaren/installation-guide-of-maskrcnn: Mask R-CNN creates a high-quality segmentation mask in addition to the Faster R-CNN network. In addition to class labels and scores, a segmentation mask is created for the objects detected by this neural network. In this repository, using Anaconda prompt step by step Mask R-CNN setup is shown.</a></li>
</ol>
<h5 id="博客"><a href="#博客" class="headerlink" title="博客"></a>博客</h5><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37541097/article/details/123754766">Mask R-CNN 网络详解_maskrcnn-CSDN 博客</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zimiao552147572/article/details/105300202?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0-105300202-blog-123754766.235%5Ev43%5Epc_blog_bottom_relevance_base8&spm=1001.2101.3001.4242.1&utm_relevant_index=2">目标分割：Mask RCNN_mask r-cnn-CSDN 博客</a></li>
</ol>
<h5 id="论文"><a href="#论文" class="headerlink" title="论文"></a>论文</h5><ol>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1703.06870">arxiv.org/pdf/1703.06870</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1908.04373">MULAN: Multitask Universal Lesion Analysis Network for Joint Lesion Detection, Tagging, and Segmentation</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1901.03353">RetinaMask: Learning to predict masks improves state-of-the-art single-shot detection for free</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1904.01355">FCOS: Fully Convolutional One-Stage Object Detection</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1909.04868">Is Sampling Heuristics Necessary in Training Deep Object Detectors?</a></li>
</ol>
<hr>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/2025/02/16/2025-02-16-%E5%85%A8%E6%99%AF%E5%88%86%E5%89%B2/">2025-02-16-全景分割</a></li>
                
                
                    <li>下一篇: <a href="/2025/02/15/2025-02-15-%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2/">2025-02-15-语义分割</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag">深度学习</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/20250927100251272.jpg?imageSlim" alt="ttkqwe" />
            </figure>
        
            <div class="author-info">
                <h4>ttkqwe</h4>
                <p>计算机大三学生，喜欢研究一些乱七八糟的东西，目前研究方向是深度学习。本站未注明转载的文章均为原创，并采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow">CC BY-NC-SA 4.0</a> 授权协议，<span style="color: #E91E63">转载请注明来源</span>，谢谢！如本站内容对你有所帮助的话，不妨 <a target="_blank" rel="noopener" href="https://paul.ren/donate">捐助支持</a> 一下？同时欢迎订阅关注 <a href="https://paul.ren/note" target="_blank">我的日记</a>，唠嗑（分享）每日的折腾经历。</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <button class="to-top" href="#"></button>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/07/29/2025-07-29-%E4%B9%9D%E6%A0%BC%E9%80%9A%E7%94%A8%E5%9F%BA%E7%A1%80%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">2025-07-29-九格通用基础大模型环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/07/03/2025-07-03-%E6%8B%AF%E6%95%91%E6%88%91%E7%9A%84%E2%80%9C%E9%AB%98%E7%83%A7%E2%80%9D%E6%88%98%E5%8F%8B%E2%80%94%E2%80%94Y7000P%202024%E7%89%88%E6%B8%85%E7%81%B0%E6%8D%A2%E7%A1%85%E8%84%82%E8%AE%B0%E5%BD%95/">2025-07-03-拯救我的“高烧”战友——Y7000P 2024 版清灰换硅脂记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/08/2025-06-08-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%95%E5%B1%82%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">2025-06-08-大模型底层技术分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/05/2025-06-05-%E6%99%BA%E8%83%BD%E4%BD%93%E5%B9%B3%E5%8F%B0%E5%8F%8A%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">2025-06-05-智能体平台及关键技术分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/04/2025-06-04-%E4%BD%8E%E4%BB%A3%E7%A0%81%E5%B9%B3%E5%8F%B0%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D/">2025-06-04-低代码平台及相关技术介绍应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/03/2025-06-03-%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3/">2025-06-03-微信小程序开发框架详解</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">七月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">六月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">五月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">四月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">三月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">二月 2025</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1/" style="font-size: 10px;">数学建模</a> <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size: 14px;">深度学习</a> <a href="/tags/%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91/" style="font-size: 18px;">程序开发</a> <a href="/tags/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">算法学习</a> <a href="/tags/%E7%AE%97%E6%B3%95%E7%BB%83%E4%B9%A0/" style="font-size: 16px;">算法练习</a> <a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size: 12px;">论文阅读</a> <a href="/tags/%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/" style="font-size: 20px;">课程学习</a> <a href="/tags/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" style="font-size: 18px;">问题解决</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2025 <a href="/">TK的小站</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":true,"night":true});</script>

  </body>
</html>
