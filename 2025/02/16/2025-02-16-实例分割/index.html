<!DOCTYPE html>
<html lang="zh">
  <head>
    
    <meta charset="UTF-8">
    <title>实例分割 - TK的小站</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:site_name" content="TK的小站">
    <meta property="og:title" content="实例分割"/>
    
    <style>body:before{ content: ''; background-image: url(https://api.paugram.com/wallpaper?source=gh) }</style>
    
<meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="TK的小站" type="application/atom+xml">
</head>

  <body>
    <header>
    <div class="head-title">
        <h4>TK的小站</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a href>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/%E8%BF%9B%E5%87%BB%E7%9A%84%E7%A0%81%E5%86%9C/">进击的码农</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
            <a href="/friends">朋友们</a>
        
            <a href="/tools">工具推荐</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>实例分割</h2>
            <div class="post-meta">
                <time class="date">2025.02.16</time>
            
            </div>
        </section>
        <article class="post-content">
        
            <blockquote>这篇文章上次修改于 242 天前，可能其部分内容已经发生变化，如有疑问可询问作者。</blockquote>
        
            <h1 id="实例分割（Instance-Segmentation）"><a href="#实例分割（Instance-Segmentation）" class="headerlink" title="实例分割（Instance Segmentation）"></a><strong>实例分割（Instance Segmentation）</strong></h1><h2 id="定义"><a href="#定义" class="headerlink" title="** 定义**"></a>** 定义**</h2><p>实例分割是目标检测和语义分割的结合，旨在精确识别图像中的每个目标对象，并区分同一类别中的不同实例。例如，在一张包含多个人的图像中，实例分割不仅需要识别出“人”这一类别，还需要将每个人单独区分开来，为每个人生成独立的分割掩码（Mask）。</p>
<p>实例分割通过融合目标检测和语义分割的结果来实现这一目标。具体而言，它利用目标检测提供的目标类别和位置信息（如边界框和置信度），从语义分割的结果中提取出对应目标的像素级掩码。简而言之，实例分割的任务是将同一类别中的具体对象（即实例）分别分割出来。</p>
<p>举个例子,近年来，随着自动驾驶等领域的快速发展，实例分割任务受到了广泛关注。自动驾驶场景中，精确区分和分割道路上的行人、车辆等目标对于环境感知和决策至关重要。此外，一些实例分割任务还会输出检测结果（如边界框），以提供更全面的目标描述。</p>
<p>对实例分割、语义分割和目标检测混合任务感兴趣的读者，可以参考 CVPR 2019 的论文《Hybrid Task Cascade》（HTC），该研究提出了一种混合任务级联框架，能够同时处理这三种任务，为多任务学习提供了新的思路。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a><strong>特点</strong></h2><ul>
<li>能够精确地定位和区分同一类别的不同实例。</li>
<li>计算成本较高，因为需要对每个目标实例进行单独检测和分类。</li>
</ul>
<h2 id="应用"><a href="#应用" class="headerlink" title="** 应用**"></a>** 应用**</h2><p>实例分割在以下领域有重要应用：</p>
<ul>
<li><strong>自动驾驶</strong>：用于检测和分割车辆、行人。</li>
<li><strong>医学成像</strong>：用于检测组织和病理的特定边界。</li>
<li><strong>机器人视觉</strong>：用于识别和隔离目标物体。</li>
</ul>
<h2 id="常见模型"><a href="#常见模型" class="headerlink" title="** 常见模型**"></a>** 常见模型**</h2><h3 id="Mask-R-CNN"><a href="#Mask-R-CNN" class="headerlink" title="Mask R-CNN"></a><strong>Mask R-CNN</strong></h3><ul>
<li><strong>优点</strong>：能够同时进行目标检测和语义分割，具有较好的性能。</li>
<li><strong>缺点</strong>：模型参数多，训练和推理速度较慢；大目标的边缘分割较为粗糙。</li>
</ul>
<h4 id="提出初衷"><a href="#提出初衷" class="headerlink" title="提出初衷"></a>提出初衷</h4><p>Mask R-CNN 是 2017 年发表的文章，一作是何恺明大神，没错就是那个男人，除此之外还有 Faster R-CNN 系列的大神 Ross Girshick，可以说是强强联合。该论文也获得了 ICCV 2017 的最佳论文奖（Marr Prize）。并且该网络提出后，又霸榜了 MS COCO 的各项任务，包括目标检测、实例分割以及人体关键点检测任务。Mask R-CNN 的结构很简洁而且很灵活效果又很好（仅仅是在 Faster R-CNN 的基础上根据需求加入一些新的分支）。<br>Mask R-CNN 的提出初衷是为了实现高效且精确的实例分割任务，同时继承 Faster R-CNN 在目标检测方面的优势。具体而言，Mask R-CNN 的核心动机是将目标检测与语义分割相结合，既能检测图像中的目标并定位其边界框，又能为每个目标生成精确的像素级分割掩码。此外，Mask R-CNN 通过引入 RoI Align 技术，解决了 Faster R-CNN 中 RoI Pooling 导致的特征图与原始图像区域对齐不精确的问题，显著提高了分割掩码的精度。Mask R-CNN 在 Faster R-CNN 的基础上增加了全卷积网络（FCN）分支，用于预测每个感兴趣区域（RoI）的分割掩码，这种设计不仅简单高效，且只增加了较小的计算开销。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407201646JSjbb2yMTo66D3xSrKfcVwQCnSc.png" alt="1740407201646JSjbb2yMTo66D3xSrKfcVwQCnSc.png"><br>它还具备良好的多任务扩展性，能够轻松扩展到其他任务（如人体关键点检测），成为一种通用的视觉框架。通过为每个类别预测独立的二元掩码，Mask R-CNN 能够更好地提取目标的空间布局信息，从而生成更精确的分割掩码，并在 COCO 等数据集上取得了显著优于当时其他模型的性能。总之，Mask R-CNN 的提出填补了目标检测和语义分割之间的空白，提供了一种高精度、高效率的实例分割解决方案。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407212685Z2kFbwjzroUn5Xx4JNDcueDNnK2.png" alt="1740407212685Z2kFbwjzroUn5Xx4JNDcueDNnK2.png"><br>Mask R-CNN 的提出初衷是为了实现高效且精确的实例分割任务，同时继承 Faster R-CNN 在目标检测方面的优势。具体动机和背景如下：</p>
<ol>
<li><strong>结合目标检测与语义分割</strong><br>在 Mask R-CNN 提出之前，目标检测（如 Faster R-CNN）和语义分割（如 FCN）是两个独立的领域。Mask R-CNN 的核心动机是将两者结合起来，既能够检测图像中的目标并定位其边界框，还能为每个目标生成精确的像素级分割掩码。</li>
<li><strong>解决像素级对齐问题</strong><br>Faster R-CNN 在处理像素级任务时存在局限性，尤其是其 RoI Pooling 操作会导致特征图与原始图像区域的对齐不精确。Mask R-CNN 通过引入 RoI Align 技术，解决了这一问题，显著提高了分割掩码的精度。</li>
<li><strong>简单高效的架构设计</strong><br>Mask R-CNN 在 Faster R-CNN 的基础上，增加了一个全卷积网络（FCN）分支，用于预测每个感兴趣区域（RoI）的分割掩码。这种设计不仅简单高效，而且只增加了较小的计算开销。</li>
<li><strong>多任务学习的扩展性</strong><br>Mask R-CNN 不仅适用于实例分割，还可以轻松扩展到其他任务，如人体关键点检测。这种多任务扩展性使其成为一种通用的视觉框架。</li>
<li><strong>提升实例分割精度</strong><br>通过为每个类别预测独立的二元掩码，Mask R-CNN 能够更好地提取目标的空间布局信息，从而生成更精确的分割掩码。这一改进使其在 COCO 等数据集上取得了显著优于当时其他模型的性能。</li>
</ol>
<h4 id="网络结构"><a href="#网络结构" class="headerlink" title="网络结构"></a>网络结构</h4><p>Mask R-CNN 的结构也很简单，就是在通过 RoIAlign（在原 Faster R-CNN 中是 RoIPool）得到的 RoI 基础上并行添加一个 Mask 分支（小型的 FCN）。见下图，之前 Faster R-CNN 是在 RoI 基础上接上一个 Fast R-CNN 检测头，即图中 class, box 分支，现在又并行了一个 Mask 分支。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407241647NcMPbytf4o9G40xNM1UcgSMbn4f.png" alt="1740407241647NcMPbytf4o9G40xNM1UcgSMbn4f.png"></p>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407249647WI67bCnZrobIRSx9aWhclwDEnlj.png" alt="1740407249647WI67bCnZrobIRSx9aWhclwDEnlj.png"><br>注意带和不带 FPN 结构的 Mask R-CNN 在 Mask 分支上略有不同，对于带有 FPN 结构的 Mask R-CNN 它的 class、box 分支和 Mask 分支并不是共用一个 RoIAlign。在训练过程中，对于 class, box 分支 RoIAlign 将 RPN（Region Proposal Network）得到的 Proposals 池化到 7x7 大小，而对于 Mask 分支 RoIAlign 将 Proposals 池化到 14x14 大小。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407261695EyHvbUkC0ouDKnxVfEGcm0iKnKd.png" alt="1740407261695EyHvbUkC0ouDKnxVfEGcm0iKnKd.png"></p>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740407267643MVthb679voUnaYxQpPBcDtJCnIf.png" alt="1740407267643MVthb679voUnaYxQpPBcDtJCnIf.png"></p>
<blockquote>
<p>Q:<strong>Mask R-CNN 中的 RoI Align 技术是如何解决 Faster R-CNN 中 RoI Pooling 导致的特征图与原始图像区域对齐不精确的问题的呢？</strong></p>
</blockquote>
<h4 id="模型代码"><a href="#模型代码" class="headerlink" title="模型代码"></a>模型代码</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""
Model definitions

"""</span>
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> math

<span class="token keyword">from</span> model<span class="token punctuation">.</span>resnet <span class="token keyword">import</span> resnet50
<span class="token keyword">from</span> model<span class="token punctuation">.</span>rpn <span class="token keyword">import</span> RPN
<span class="token comment">#from model.lib.roi_align.roi_align.roi_align import RoIAlign</span>
<span class="token keyword">from</span> model<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>roi_align<span class="token punctuation">.</span>roi_align<span class="token punctuation">.</span>crop_and_resize <span class="token keyword">import</span> CropAndResize
<span class="token keyword">from</span> model<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>bbox<span class="token punctuation">.</span>generate_anchors <span class="token keyword">import</span> generate_pyramid_anchors
<span class="token keyword">from</span> model<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>bbox<span class="token punctuation">.</span>nms <span class="token keyword">import</span> torch_nms <span class="token keyword">as</span> nms


<span class="token keyword">def</span> <span class="token function">log2_graph</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Implementatin of Log2. pytorch doesn't have a native implemenation."""</span>
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>div<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">ROIAlign</span><span class="token punctuation">(</span>feature_maps<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> config<span class="token punctuation">,</span> pool_size<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Implements ROI Align on the features.
    Params:
    - pool_shape: [height, width] of the output pooled regions. Usually [7, 7]
    - image_shape: [height, width, chanells]. Shape of input image in pixels
    Inputs:
    - boxes: [batch, num_boxes, (x1, y1, x2, y2)] in normalized
             coordinates. Possibly padded with zeros if not enough
             boxes to fill the array.
    - Feature maps: List of feature maps from different levels of the pyramid.
                    Each is [batch, channels, height, width]
    Output:
    Pooled regions in the shape: [batch, num_boxes, height, width, channels].
    The width and height are those specific in the pool_shape in the layer
    constructor.
    """</span>
    <span class="token triple-quoted-string string">"""
    [  x2-x1             x1 + x2 - W + 1  ]
    [  -----      0      ---------------  ]
    [  W - 1                  W - 1       ]
    [                                     ]
    [           y2-y1    y1 + y2 - H + 1  ]
    [    0      -----    ---------------  ]
    [           H - 1         H - 1      ]
    """</span>
    <span class="token comment">#feature_maps= [P2, P3, P4, P5]</span>
    rois <span class="token operator">=</span> rois<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
    crop_resize <span class="token operator">=</span> CropAndResize<span class="token punctuation">(</span>pool_size<span class="token punctuation">,</span> pool_size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    roi_number <span class="token operator">=</span> rois<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    pooled <span class="token operator">=</span> rois<span class="token punctuation">.</span>data<span class="token punctuation">.</span>new<span class="token punctuation">(</span>
            config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token operator">*</span>rois<span class="token punctuation">.</span>size<span class="token punctuation">(</span>
            <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> pool_size<span class="token punctuation">,</span> pool_size<span class="token punctuation">)</span><span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>

    rois <span class="token operator">=</span> rois<span class="token punctuation">.</span>view<span class="token punctuation">(</span>
            config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token operator">*</span>rois<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token comment"># Loop through levels and apply ROI pooling to each. P2 to P5.</span>
    x_1 <span class="token operator">=</span> rois<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    y_1 <span class="token operator">=</span> rois<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    x_2 <span class="token operator">=</span> rois<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    y_2 <span class="token operator">=</span> rois<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>

    roi_level <span class="token operator">=</span> log2_graph<span class="token punctuation">(</span>
        torch<span class="token punctuation">.</span>div<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>y_2 <span class="token operator">-</span> y_1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x_2 <span class="token operator">-</span> x_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">224.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    roi_level <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>
        torch<span class="token punctuation">.</span>add<span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>roi_level<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token comment"># P2 is 256x256, P3 is 128x128, P4 is 64x64, P5 is 32x32</span>
    <span class="token comment"># P2 is 4, P3 is 8, P4 is 16, P5 is 32</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> level <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        scaling_ratio <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">**</span>level

        height <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>IMAGE_MAX_DIM<span class="token punctuation">)</span><span class="token operator">/</span> scaling_ratio
        width <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>IMAGE_MAX_DIM<span class="token punctuation">)</span> <span class="token operator">/</span> scaling_ratio

        ixx <span class="token operator">=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>roi_level<span class="token punctuation">,</span> level<span class="token punctuation">)</span>

        box_indices <span class="token operator">=</span> ixx<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0</span>
        ix <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>ixx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        level_boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>masked_select<span class="token punctuation">(</span>rois<span class="token punctuation">,</span> ix<span class="token punctuation">)</span>
        <span class="token keyword">if</span> level_boxes<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        level_boxes <span class="token operator">=</span> level_boxes<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

        crops <span class="token operator">=</span> crop_resize<span class="token punctuation">(</span>feature_maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>div<span class="token punctuation">(</span>
                level_boxes<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>IMAGE_MAX_DIM<span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box_indices<span class="token punctuation">)</span>

        indices_pooled <span class="token operator">=</span> ixx<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        pooled<span class="token punctuation">[</span>indices_pooled<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> crops<span class="token punctuation">.</span>data

    pooled <span class="token operator">=</span> pooled<span class="token punctuation">.</span>view<span class="token punctuation">(</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">,</span> roi_number<span class="token punctuation">,</span>
               <span class="token number">256</span><span class="token punctuation">,</span> pool_size<span class="token punctuation">,</span> pool_size<span class="token punctuation">)</span>
    pooled <span class="token operator">=</span> Variable<span class="token punctuation">(</span>pooled<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pooled


<span class="token comment"># ---------------------------------------------------------------</span>
<span class="token comment"># Heads</span>

<span class="token keyword">class</span> <span class="token class-name">MaskHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MaskHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
        self<span class="token punctuation">.</span>num_classes <span class="token operator">=</span> config<span class="token punctuation">.</span>NUM_CLASSES
        <span class="token comment">#self.crop_size = config.mask_crop_size</span>

        <span class="token comment">#self.roi_align = RoIAlign(self.crop_size, self.crop_size)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>deconv <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mask <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> rpn_rois<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#x = self.roi_align(x, rpn_rois)</span>
        x <span class="token operator">=</span> ROIAlign<span class="token punctuation">(</span>x<span class="token punctuation">,</span> rpn_rois<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MASK_POOL_SIZE<span class="token punctuation">)</span>

        roi_number <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment"># merge batch and roi number together</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU <span class="token operator">*</span> roi_number<span class="token punctuation">,</span>
                   <span class="token number">256</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MASK_POOL_SIZE<span class="token punctuation">,</span>
                   self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MASK_POOL_SIZE<span class="token punctuation">)</span>

        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn3<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn4<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>deconv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        rcnn_mask_logits <span class="token operator">=</span> self<span class="token punctuation">.</span>mask<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        rcnn_mask_logits <span class="token operator">=</span> rcnn_mask_logits<span class="token punctuation">.</span>view<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">,</span>
                                                 roi_number<span class="token punctuation">,</span>
                                                 self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>NUM_CLASSES<span class="token punctuation">,</span>
                                                 self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MASK_POOL_SIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                                                 self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MASK_POOL_SIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> rcnn_mask_logits


<span class="token keyword">class</span> <span class="token class-name">RCNNHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RCNNHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
        self<span class="token punctuation">.</span>num_classes <span class="token operator">=</span> config<span class="token punctuation">.</span>NUM_CLASSES
        <span class="token comment">#self.crop_size = config.rcnn_crop_size</span>

        <span class="token comment">#self.roi_align = RoIAlign(self.crop_size, self.crop_size)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>class_logits <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bbox <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>POOL_SIZE<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> rpn_rois<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> ROIAlign<span class="token punctuation">(</span>x<span class="token punctuation">,</span> rpn_rois<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>POOL_SIZE<span class="token punctuation">)</span>
        roi_number <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU <span class="token operator">*</span> roi_number<span class="token punctuation">,</span>
                   <span class="token number">256</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>POOL_SIZE<span class="token punctuation">,</span>
                   self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>POOL_SIZE<span class="token punctuation">)</span>
        <span class="token comment">#print(x.shape)</span>
        <span class="token comment">#x = self.roi_align(x, rpn_rois, self.config, self.config.POOL_SIZE)</span>
        <span class="token comment">#x = crops.view(crops.size(0), -1)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment">#x = F.dropout(x, 0.5, training=self.training)</span>
        rcnn_class_logits <span class="token operator">=</span> self<span class="token punctuation">.</span>class_logits<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        rcnn_probs <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>rcnn_class_logits<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        rcnn_bbox <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        rcnn_class_logits <span class="token operator">=</span> rcnn_class_logits<span class="token punctuation">.</span>view<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">,</span>
                                                   roi_number<span class="token punctuation">,</span>
                                                   rcnn_class_logits<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        rcnn_probs <span class="token operator">=</span> rcnn_probs<span class="token punctuation">.</span>view<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">,</span>
                                     roi_number<span class="token punctuation">,</span>
                                     rcnn_probs<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        rcnn_bbox <span class="token operator">=</span> rcnn_bbox<span class="token punctuation">.</span>view<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">,</span>
                                   roi_number<span class="token punctuation">,</span>
                                   self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>NUM_CLASSES<span class="token punctuation">,</span>
                                   <span class="token number">4</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> rcnn_class_logits<span class="token punctuation">,</span> rcnn_probs<span class="token punctuation">,</span> rcnn_bbox


<span class="token comment">#</span>
<span class="token comment"># ---------------------------------------------------------------</span>
<span class="token comment"># Mask R-CNN</span>

<span class="token keyword">class</span> <span class="token class-name">MaskRCNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Mask R-CNN model
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MaskRCNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
        self<span class="token punctuation">.</span>__mode <span class="token operator">=</span> <span class="token string">'train'</span>
        feature_channels <span class="token operator">=</span> <span class="token number">128</span>
        <span class="token comment"># define modules (set of layers)</span>
<span class="token comment">#        self.feature_net = FeatureNet(cfg, 3, feature_channels)</span>
        self<span class="token punctuation">.</span>feature_net <span class="token operator">=</span> resnet50<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#self.rpn_head = RpnMultiHead(cfg,feature_channels)</span>
        self<span class="token punctuation">.</span>rpn <span class="token operator">=</span> RPN<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RPN_ANCHOR_RATIOS<span class="token punctuation">)</span><span class="token punctuation">,</span>
                             self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RPN_ANCHOR_STRIDE<span class="token punctuation">)</span>
        <span class="token comment">#self.rcnn_crop = CropRoi(cfg, cfg.rcnn_crop_size)</span>
        self<span class="token punctuation">.</span>rcnn_head <span class="token operator">=</span> RCNNHead<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
        <span class="token comment">#self.mask_crop = CropRoi(cfg, cfg.mask_crop_size)</span>
        self<span class="token punctuation">.</span>mask_head <span class="token operator">=</span> MaskHead<span class="token punctuation">(</span>config<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>anchors <span class="token operator">=</span> generate_pyramid_anchors<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RPN_ANCHOR_SCALES<span class="token punctuation">,</span>
                                                self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RPN_ANCHOR_RATIOS<span class="token punctuation">,</span>
                                                self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>BACKBONE_SHAPES<span class="token punctuation">,</span>
                                                self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>BACKBONE_STRIDES<span class="token punctuation">,</span>
                                                self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RPN_ANCHOR_STRIDE<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>proposal_count <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>POST_NMS_ROIS_TRAINING
        <span class="token comment"># FPN</span>
        self<span class="token punctuation">.</span>fpn_c5p5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            <span class="token number">512</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fpn_c4p4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            <span class="token number">256</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fpn_c3p3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            <span class="token number">128</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fpn_c2p2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>fpn_p2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fpn_p3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fpn_p4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fpn_p5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>scale_ratios <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>fpn_p6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>
            kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> ceil_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Extract features</span>
        C1<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> C4<span class="token punctuation">,</span> C5 <span class="token operator">=</span> self<span class="token punctuation">.</span>feature_net<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_c5p5<span class="token punctuation">(</span>C5<span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_c4p4<span class="token punctuation">(</span>C4<span class="token punctuation">)</span> <span class="token operator">+</span> F<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P5<span class="token punctuation">,</span>
                                            scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">)</span>
        P3 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_c3p3<span class="token punctuation">(</span>C3<span class="token punctuation">)</span> <span class="token operator">+</span> F<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P4<span class="token punctuation">,</span>
                                            scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">)</span>
        P2 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_c2p2<span class="token punctuation">(</span>C2<span class="token punctuation">)</span> <span class="token operator">+</span> F<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P3<span class="token punctuation">,</span>
                                            scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">)</span>

        <span class="token comment"># Attach 3x3 conv to all P layers to get the final feature maps.</span>
        <span class="token comment"># P2 is 256, P3 is 128, P4 is 64, P5 is 32</span>
        P2 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_p2<span class="token punctuation">(</span>P2<span class="token punctuation">)</span>
        P3 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_p3<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_p4<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_p5<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        <span class="token comment"># P6 is used for the 5th anchor scale in RPN. Generated by</span>
        <span class="token comment"># subsampling from P5 with stride of 2.</span>
        P6 <span class="token operator">=</span> self<span class="token punctuation">.</span>fpn_p6<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>

        <span class="token comment"># Note that P6 is used in RPN, but not in the classifier heads.</span>
        rpn_feature_maps <span class="token operator">=</span> <span class="token punctuation">[</span>P2<span class="token punctuation">,</span> P3<span class="token punctuation">,</span> P4<span class="token punctuation">,</span> P5<span class="token punctuation">,</span> P6<span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>mrcnn_feature_maps <span class="token operator">=</span> <span class="token punctuation">[</span>P2<span class="token punctuation">,</span> P3<span class="token punctuation">,</span> P4<span class="token punctuation">,</span> P5<span class="token punctuation">]</span>

        rpn_class_logits_outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        rpn_class_outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        rpn_bbox_outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># RPN proposals</span>
        <span class="token keyword">for</span> feature <span class="token keyword">in</span> rpn_feature_maps<span class="token punctuation">:</span>
            rpn_class_logits<span class="token punctuation">,</span> rpn_probs<span class="token punctuation">,</span> rpn_bbox <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn<span class="token punctuation">(</span>feature<span class="token punctuation">)</span>
            rpn_class_logits_outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rpn_class_logits<span class="token punctuation">)</span>
            rpn_class_outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rpn_probs<span class="token punctuation">)</span>
            rpn_bbox_outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rpn_bbox<span class="token punctuation">)</span>

        rpn_class_logits <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>rpn_class_logits_outputs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        rpn_class <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>rpn_class_outputs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        rpn_bbox <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>rpn_bbox_outputs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        rpn_proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>proposal_layer<span class="token punctuation">(</span>rpn_class<span class="token punctuation">,</span> rpn_bbox<span class="token punctuation">)</span>

        <span class="token comment"># RCNN proposals</span>
        rcnn_class_logits<span class="token punctuation">,</span> rcnn_class<span class="token punctuation">,</span> rcnn_bbox <span class="token operator">=</span> self<span class="token punctuation">.</span>rcnn_head<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mrcnn_feature_maps<span class="token punctuation">,</span> rpn_proposals<span class="token punctuation">)</span>
        rcnn_mask_logits <span class="token operator">=</span> self<span class="token punctuation">.</span>mask_head<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mrcnn_feature_maps<span class="token punctuation">,</span> rpn_proposals<span class="token punctuation">)</span>
        <span class="token comment"># &lt;todo&gt; mask nms</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span>rpn_class_logits<span class="token punctuation">,</span> rpn_class<span class="token punctuation">,</span> rpn_bbox<span class="token punctuation">,</span> rpn_proposals<span class="token punctuation">,</span>
                rcnn_class_logits<span class="token punctuation">,</span> rcnn_class<span class="token punctuation">,</span> rcnn_bbox<span class="token punctuation">,</span>
                rcnn_mask_logits<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">proposal_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rpn_class<span class="token punctuation">,</span> rpn_bbox<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># handling proposals</span>
        scores <span class="token operator">=</span> rpn_class<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment">#print(scores.shape)</span>
        <span class="token comment"># Box deltas [batch, num_rois, 4]</span>
        deltas_mul <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RPN_BBOX_STD_DEV<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        deltas <span class="token operator">=</span> rpn_bbox <span class="token operator">*</span> deltas_mul

        pre_nms_limit <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        scores<span class="token punctuation">,</span> ix <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>scores<span class="token punctuation">,</span> pre_nms_limit<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                                largest<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">sorted</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        ix <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>ix<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        ix <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>ix<span class="token punctuation">,</span> ix<span class="token punctuation">,</span> ix<span class="token punctuation">,</span> ix<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        deltas <span class="token operator">=</span> torch<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>deltas<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ix<span class="token punctuation">)</span>

        _anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">)</span><span class="token punctuation">:</span>
            anchors <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            _anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span>
        anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>_anchors<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        pre_nms_anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ix<span class="token punctuation">)</span>
        refined_anchors <span class="token operator">=</span> apply_box_deltas_graph<span class="token punctuation">(</span>pre_nms_anchors<span class="token punctuation">,</span> deltas<span class="token punctuation">)</span>

        <span class="token comment"># Clip to image boundaries. [batch, N, (y1, x1, y2, x2)]</span>
        height<span class="token punctuation">,</span> width <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGE_SHAPE<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        window <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        window <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

        refined_anchors_clipped <span class="token operator">=</span> clip_boxes_graph<span class="token punctuation">(</span>refined_anchors<span class="token punctuation">,</span> window<span class="token punctuation">)</span>

        refined_proposals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        scores <span class="token operator">=</span> scores<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span>
        <span class="token comment">#print(scores.data.shape)</span>
        <span class="token comment">#print(refined_anchors_clipped.data.shape)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>IMAGES_PER_GPU<span class="token punctuation">)</span><span class="token punctuation">:</span>
            indices <span class="token operator">=</span> nms<span class="token punctuation">(</span>
                torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>refined_anchors_clipped<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> scores<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span>
            indices <span class="token operator">=</span> indices<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>proposal_count<span class="token punctuation">]</span>
            indices <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>indices<span class="token punctuation">,</span> indices<span class="token punctuation">,</span> indices<span class="token punctuation">,</span> indices<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            indices <span class="token operator">=</span> Variable<span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            proposals <span class="token operator">=</span> torch<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>refined_anchors_clipped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> indices<span class="token punctuation">)</span>
            padding <span class="token operator">=</span> self<span class="token punctuation">.</span>proposal_count <span class="token operator">-</span> proposals<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            proposals <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>
                <span class="token punctuation">[</span>proposals<span class="token punctuation">,</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>padding<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            refined_proposals<span class="token punctuation">.</span>append<span class="token punctuation">(</span>proposals<span class="token punctuation">)</span>

        rpn_rois <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>refined_proposals<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> rpn_rois


<span class="token keyword">def</span> <span class="token function">apply_box_deltas_graph</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> deltas<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Applies the given deltas to the given boxes.
    boxes: [N, 4] where each row is y1, x1, y2, x2
    deltas: [N, 4] where each row is [dy, dx, log(dh), log(dw)]
    """</span>
    <span class="token comment"># Convert to y, x, h, w</span>
    height <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    width <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    center_y <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> height
    center_x <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> width
    <span class="token comment"># Apply deltas</span>
    center_y <span class="token operator">+=</span> deltas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> height
    center_x <span class="token operator">+=</span> deltas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> width
    height <span class="token operator">*=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>deltas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    width <span class="token operator">*=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>deltas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># Convert back to y1, x1, y2, x2</span>
    y1 <span class="token operator">=</span> center_y <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> height
    x1 <span class="token operator">=</span> center_x <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> width
    y2 <span class="token operator">=</span> y1 <span class="token operator">+</span> height
    x2 <span class="token operator">=</span> x1 <span class="token operator">+</span> width
    result <span class="token operator">=</span> <span class="token punctuation">[</span>y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2<span class="token punctuation">]</span>
    <span class="token keyword">return</span> result


<span class="token keyword">def</span> <span class="token function">clip_boxes_graph</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    boxes: [N, 4] each row is y1, x1, y2, x2
    window: [4] in the form y1, x1, y2, x2
    """</span>
    <span class="token comment"># Split corners</span>
    wy1<span class="token punctuation">,</span> wx1<span class="token punctuation">,</span> wy2<span class="token punctuation">,</span> wx2 <span class="token operator">=</span> window
    y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2 <span class="token operator">=</span> boxes
    <span class="token comment"># Clip</span>

    y1 <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>y1<span class="token punctuation">,</span> wy2<span class="token punctuation">)</span><span class="token punctuation">,</span> wy1<span class="token punctuation">)</span>
    x1 <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> wx2<span class="token punctuation">)</span><span class="token punctuation">,</span> wx1<span class="token punctuation">)</span>
    y2 <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>y2<span class="token punctuation">,</span> wy2<span class="token punctuation">)</span><span class="token punctuation">,</span> wy1<span class="token punctuation">)</span>
    x2 <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> wx2<span class="token punctuation">)</span><span class="token punctuation">,</span> wx1<span class="token punctuation">)</span>

    clipped <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> clipped<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h4><h5 id="项目"><a href="#项目" class="headerlink" title="项目"></a><strong>项目</strong></h5><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/JenifferWuUCLA/pulmonary-nodules-MaskRCNN/tree/master">JenifferWuUCLA/pulmonary-nodules-MaskRCNN: Mask R-CNN for Pulmonary Nodules Diagnosis, using TensorFlow 天池医疗 AI 大赛：Mask R-CNN 肺部结节智能检测（Segmentation + Classification）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/facebookresearch/maskrcnn-benchmark">facebookresearch/maskrcnn-benchmark: Fast, modular reference implementation of Instance Segmentation and Object Detection algorithms in PyTorch.</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/leon-liangwu/MaskYolo_Caffe?tab=readme-ov-file">leon-liangwu/MaskYolo_Caffe: YOLO V2 &amp; V3 , YOLO Combined with RCNN and MaskRCNN</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/TannerGilbert/MaskRCNN-Object-Detection-and-Segmentation">TannerGilbert/MaskRCNN-Object-Detection-and-Segmentation: Train your own custom MaskRCNN Object Detection and Instance Segmentation model.</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/CharlesShang/FastMaskRCNN">CharlesShang/FastMaskRCNN: Mask RCNN in TensorFlow</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/buseyaren/installation-guide-of-maskrcnn?tab=readme-ov-file">buseyaren/installation-guide-of-maskrcnn: Mask R-CNN creates a high-quality segmentation mask in addition to the Faster R-CNN network. In addition to class labels and scores, a segmentation mask is created for the objects detected by this neural network. In this repository, using Anaconda prompt step by step Mask R-CNN setup is shown.</a></li>
</ol>
<h5 id="博客"><a href="#博客" class="headerlink" title="博客"></a>博客</h5><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37541097/article/details/123754766">Mask R-CNN 网络详解_maskrcnn-CSDN 博客</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zimiao552147572/article/details/105300202?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0-105300202-blog-123754766.235%5Ev43%5Epc_blog_bottom_relevance_base8&spm=1001.2101.3001.4242.1&utm_relevant_index=2">目标分割：Mask RCNN_mask r-cnn-CSDN 博客</a></li>
</ol>
<h5 id="论文"><a href="#论文" class="headerlink" title="论文"></a>论文</h5><ol>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1703.06870">arxiv.org/pdf/1703.06870</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1908.04373">MULAN: Multitask Universal Lesion Analysis Network for Joint Lesion Detection, Tagging, and Segmentation</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1901.03353">RetinaMask: Learning to predict masks improves state-of-the-art single-shot detection for free</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1904.01355">FCOS: Fully Convolutional One-Stage Object Detection</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1909.04868">Is Sampling Heuristics Necessary in Training Deep Object Detectors?</a></li>
</ol>
<hr>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/2025/02/16/2025-02-16-%E5%85%A8%E6%99%AF%E5%88%86%E5%89%B2/">2025-02-16-全景分割</a></li>
                
                
                    <li>下一篇: <a href="/2025/02/15/2025-02-15-%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2/">2025-02-15-语义分割</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/deep-learning/" rel="tag">深度学习</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/20250927100251272.jpg?imageSlim" alt="ttkqwe" />
            </figure>
        
            <div class="author-info">
                <h4>ttkqwe</h4>
                <p>计算机大三学生，喜欢研究一些乱七八糟的东西，目前研究方向是深度学习。本站未注明转载的文章均为原创，并采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow">CC BY-NC-SA 4.0</a> 授权协议，<span style="color: #E91E63">转载请注明来源</span>，谢谢！</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <button class="to-top" href="#"></button>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/10/15/2025-10-15-python%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%BC%8F%E4%B8%8Emap%E5%87%BD%E6%95%B0/">2025-10-15-python列表推导式与map函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/10/14/2025-10-14-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AE%9E%E9%AA%8C%E4%BA%8C-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95%EF%BC%88Telnet%EF%BC%89/">2025-10-14-计算机网络实验二-交换机基本配置与远程登录（Telnet）</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/07/29/2025-07-29-%E4%B9%9D%E6%A0%BC%E9%80%9A%E7%94%A8%E5%9F%BA%E7%A1%80%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">2025-07-29-九格通用基础大模型环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/07/03/2025-07-03-%E6%8B%AF%E6%95%91%E6%88%91%E7%9A%84%E2%80%9C%E9%AB%98%E7%83%A7%E2%80%9D%E6%88%98%E5%8F%8B%E2%80%94%E2%80%94Y7000P%202024%E7%89%88%E6%B8%85%E7%81%B0%E6%8D%A2%E7%A1%85%E8%84%82%E8%AE%B0%E5%BD%95/">2025-07-03-拯救我的“高烧”战友——Y7000P 2024 版清灰换硅脂记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/08/2025-06-08-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%95%E5%B1%82%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">2025-06-08-大模型底层技术分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/05/2025-06-05-%E6%99%BA%E8%83%BD%E4%BD%93%E5%B9%B3%E5%8F%B0%E5%8F%8A%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">2025-06-05-智能体平台及关键技术分析</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">十月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">七月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">六月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">五月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">四月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">三月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">二月 2025</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/mathematical-modeling/" style="font-size: 10px;">数学建模</a> <a href="/tags/deep-learning/" style="font-size: 14px;">深度学习</a> <a href="/tags/development/" style="font-size: 18px;">程序开发</a> <a href="/tags/algorithm/" style="font-size: 10px;">算法学习</a> <a href="/tags/algorithm-practice/" style="font-size: 16px;">算法练习</a> <a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size: 12px;">论文阅读</a> <a href="/tags/course/" style="font-size: 20px;">课程学习</a> <a href="/tags/troubleshooting/" style="font-size: 18px;">问题解决</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>
                © 2025 <a href="/">TK的小站</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.
                
                    &nbsp;|&nbsp;
                    <a href="https://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
                        蜀ICP备2025165253号
                    </a>
                
                
                    &nbsp;|&nbsp;
                    <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11000002000001" target="_blank" rel="nofollow noopener" class="police-beian">
                        <span class="police-icon" aria-hidden="true"></span>
                        <span class="police-text">京公网安备11000002000001号</span>
                    </a>
                
            </p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":true,"night":true});</script>

<style>
.police-beian{display:inline-flex;align-items:center;gap:4px}
.police-icon{display:inline-block;width:16px;height:16px;background:#e91e63;border-radius:2px;opacity:.85}
/* 说明：如需官方警徽图标，可将 .police-icon 的 background 设置为图片：
   background:url('https://www.beian.gov.cn/img/ghs.png') no-repeat center/contain; */
</style>

  </body>
</html>
