<!DOCTYPE html>
<html lang="zh">
  <head>
    
    <meta charset="UTF-8">
    <title>2025-02-15-语义分割 - TK的小站</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:site_name" content="TK的小站">
    <meta property="og:title" content="2025-02-15-语义分割"/>
    
    <style>body:before{ content: ''; background-image: url(https://api.paugram.com/wallpaper?source=gh) }</style>
    
<meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="TK的小站" type="application/atom+xml">
</head>

  <body>
    <header>
    <div class="head-title">
        <h4>TK的小站</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a href>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/%E8%BF%9B%E5%87%BB%E7%9A%84%E7%A0%81%E5%86%9C/">进击的码农</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
            <a href="/friends">朋友们</a>
        
            <a href="/tools">工具推荐</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>2025-02-15-语义分割</h2>
            <div class="post-meta">
                <time class="date">2025.02.15</time>
            
            </div>
        </section>
        <article class="post-content">
        
            <blockquote>这篇文章上次修改于 243 天前，可能其部分内容已经发生变化，如有疑问可询问作者。</blockquote>
        
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在开始这篇文章之前，我们得首先弄明白，什么是图像分割？</p>
<p>我们知道一个图像只不过是许多像素的集合。图像分割分类是对图像中属于特定类别的像素进行分类的过程，即像素级别的下游任务。因此图像分割简单来说就是按像素进行分类的问题。</p>
<p>传统的图像分割算法均是基于灰度值的不连续和相似的性质。而基于深度学习的图像分割技术则是利用卷积神经网络，来理解图像中的每个像素所代表的真实世界物体，这在以前是难以想象的。</p>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740235822031FRBrbtq8Zogp1oxNSIhcx7Z6nVb.png" alt="1740235822031FRBrbtq8Zogp1oxNSIhcx7Z6nVb.png"></p>
<h1 id="语义分割（Semantic-Segmentation）"><a href="#语义分割（Semantic-Segmentation）" class="headerlink" title="语义分割（Semantic Segmentation）"></a><strong>语义分割（Semantic Segmentation）</strong></h1><h2 id="定义"><a href="#定义" class="headerlink" title="** 定义**"></a>** 定义**</h2><p>“语义”是个很抽象的概念，在 2D 图像领域，每个像素点作为最小单位，它的像素值代表的就是一个特征，即“语义”信息。语义分割会为图像中的每个像素分配一个类别，但是同一类别之间的对象不会区分。而实例分割，只对特定的物体进行分类。这看起来与目标检测相似，不同的是目标检测输出目标的边界框和类别，实例分割输出的是目标的 Mask 和类别。具体而言，语义分割的目的是为了从像素级别理解图像的内容，并为图像中的每个像素分配一个对象类。</p>
<p>语义分割是一种将图像中的每个像素分配给特定类别的技术。其目标是识别图像中存在的各种对象和背景，并为每个像素分配相应的类别标签。例如，将图像中的像素划分为人、树、草地和天空等不同区域。是图像处理和机器视觉一个重要分支。与分类任务不同，语义分割需要判断图像每个像素点的类别，进行精确分割。语义分割目前在自动驾驶、自动抠图、医疗影像等领域有着比较广泛的应用。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="** 特点**"></a>** 特点**</h2><ul>
<li>提供精确的像素级分类，有助于深入理解图像内容。</li>
<li>无法区分同一类别中的不同实例。</li>
</ul>
<h2 id="语义分割的应用"><a href="#语义分割的应用" class="headerlink" title="** 语义分割的应用**"></a>** 语义分割的应用**</h2><p>语义分割在多个领域有广泛应用：</p>
<ul>
<li><strong>自动驾驶</strong>：用于道路、车辆和行人的识别。</li>
<li><strong>医学成像</strong>：用于组织和器官的分割。</li>
<li><strong>卫星遥感</strong>：用于土地覆盖分类。</li>
</ul>
<h2 id="常见模型"><a href="#常见模型" class="headerlink" title="** 常见模型**"></a>** 常见模型**</h2><h3 id="FCN（Fully-Convolutional-Network）"><a href="#FCN（Fully-Convolutional-Network）" class="headerlink" title="FCN（Fully Convolutional Network）"></a><strong>FCN（Fully Convolutional Network）</strong></h3><ul>
<li><strong>优点</strong>：简单易用，但是现在已经很少使用了,但它的历史贡献不可忽视。</li>
<li><strong>缺点</strong>：分割精度较低，可能无法很好地处理细节。</li>
</ul>
<h4 id="提出初衷"><a href="#提出初衷" class="headerlink" title="提出初衷"></a>提出初衷</h4><p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740236704772Z5SNbToLOosLf9xBvllcevjVnEe.png" alt="1740236704772Z5SNbToLOosLf9xBvllcevjVnEe.png"><br>FCN（全卷积网络）模型的初衷是为了解决传统卷积神经网络（CNN）在语义分割任务中的局限性。具体而言，传统 CNN 使用全连接层进行分类，这会丢失图像的空间位置信息，导致其不适合像素级的预测任务。FCN 的核心动机包括：</p>
<ol>
<li><strong>实现端到端的像素级预测</strong>：FCN 通过将全连接层替换为卷积层，使得网络能够接受任意尺寸的输入图像，并输出与输入尺寸相同的像素级预测结果。</li>
<li><strong>保留空间信息</strong>：取消全连接层后，FCN 能够保留图像的空间位置信息，从而更好地适应语义分割任务。</li>
<li><strong>提高分割效率和精度</strong>：通过引入反卷积层（上采样层）和跳跃连接（Skip Connections），FCN 能够融合不同深度的特征，兼顾全局语义信息和局部细节，从而提升分割精度。</li>
<li><strong>利用预训练模型加速训练</strong>：FCN 可以基于预训练的分类模型（如 AlexNet、VGG 等）进行微调，从而显著加速训练过程并提高模型性能。</li>
</ol>
<h4 id="网络结构"><a href="#网络结构" class="headerlink" title="网络结构"></a>网络结构</h4><p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740236686503VcqtbHWWQoRtJIxgy6bconZQnHc.png" alt="1740236686503VcqtbHWWQoRtJIxgy6bconZQnHc.png"><br>通常 CNN 网络在卷积层之后会接上若干个全连接层, 将卷积层产生的特征图(feature map)映射成一个固定长度的特征向量。以 AlexNet 为代表的经典 CNN 结构适合于图像级的分类和回归任务，因为它们最后都期望得到整个输入图像的一个数值描述（概率）。<br>FCN 对图像进行像素级的分类，从而解决了语义级别的图像分割（semantic segmentation）问题。与经典的 CNN 在卷积层之后使用全连接层得到固定长度的特征向量进行分类（全连接层 ＋softmax 输出）不同，FCN 可以接受任意尺寸的输入图像，采用反卷积层对最后一个卷积层的 feature map 进行上采样, 使它恢复到输入图像相同的尺寸，从而可以对每个像素都产生了一个预测, 同时保留了原始输入图像中的空间信息, 最后在上采样的特征图上进行逐像素分类。<br><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740236781446CxZ6b4zcXo9A12xuNJtcEgA7nfc.png" alt="1740236781446CxZ6b4zcXo9A12xuNJtcEgA7nfc.png"><br>FCN（全卷积网络）为了解决语义分割（semantic segmentation）问题而提出，它对图像进行像素级的分类，能够保留原始输入图像中的空间信息。与传统 CNN 不同，FCN 可以接受任意尺寸的输入图像，并通过以下方式实现像素级分类：</p>
<ol>
<li><strong>去除全连接层</strong>：FCN 将传统 CNN 中的全连接层替换为卷积层，从而保留空间信息。</li>
<li><strong>上采样操作</strong>：使用反卷积层（上采样层）对最后一个卷积层的特征图进行上采样，恢复到与输入图像相同的尺寸。</li>
<li><strong>逐像素分类</strong>：在上采样后的特征图上进行逐像素分类，为每个像素生成类别预测。</li>
</ol>
<blockquote>
<p>Q:<strong>FCN 是如何通过上采样操作恢复特征图的空间分辨率的？</strong></p>
</blockquote>
<h4 id="模型代码"><a href="#模型代码" class="headerlink" title="模型代码"></a>模型代码</h4><h5 id="论文源码"><a href="#论文源码" class="headerlink" title="论文源码"></a>论文源码</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> caffe
<span class="token keyword">from</span> caffe <span class="token keyword">import</span> layers <span class="token keyword">as</span> L<span class="token punctuation">,</span> params <span class="token keyword">as</span> P
<span class="token keyword">from</span> caffe<span class="token punctuation">.</span>coord_map <span class="token keyword">import</span> crop

<span class="token keyword">def</span> <span class="token function">conv_relu</span><span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> nout<span class="token punctuation">,</span> ks<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    conv <span class="token operator">=</span> L<span class="token punctuation">.</span>Convolution<span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>ks<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
        num_output<span class="token operator">=</span>nout<span class="token punctuation">,</span> pad<span class="token operator">=</span>pad<span class="token punctuation">,</span>
        param<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> decay_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> decay_mult<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> conv<span class="token punctuation">,</span> L<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>conv<span class="token punctuation">,</span> in_place<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">max_pool</span><span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> ks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> L<span class="token punctuation">.</span>Pooling<span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> pool<span class="token operator">=</span>P<span class="token punctuation">.</span>Pooling<span class="token punctuation">.</span>MAX<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>ks<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">fcn</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> caffe<span class="token punctuation">.</span>NetSpec<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pydata_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>split<span class="token operator">=</span>split<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">104.00699</span><span class="token punctuation">,</span> <span class="token number">116.66877</span><span class="token punctuation">,</span> <span class="token number">122.67892</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            seed<span class="token operator">=</span><span class="token number">1337</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> split <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
        pydata_params<span class="token punctuation">[</span><span class="token string">'sbdd_dir'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'../data/sbdd/dataset'</span>
        pylayer <span class="token operator">=</span> <span class="token string">'SBDDSegDataLayer'</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        pydata_params<span class="token punctuation">[</span><span class="token string">'voc_dir'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'../data/pascal/VOC2011'</span>
        pylayer <span class="token operator">=</span> <span class="token string">'VOCSegDataLayer'</span>
    n<span class="token punctuation">.</span>data<span class="token punctuation">,</span> n<span class="token punctuation">.</span>label <span class="token operator">=</span> L<span class="token punctuation">.</span>Python<span class="token punctuation">(</span>module<span class="token operator">=</span><span class="token string">'voc_layers'</span><span class="token punctuation">,</span> layer<span class="token operator">=</span>pylayer<span class="token punctuation">,</span>
            ntop<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> param_str<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>pydata_params<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># the base net</span>
    n<span class="token punctuation">.</span>conv1_1<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu1_1 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>conv1_2<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu1_2 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu1_1<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>pool1 <span class="token operator">=</span> max_pool<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu1_2<span class="token punctuation">)</span>

    n<span class="token punctuation">.</span>conv2_1<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu2_1 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>pool1<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>conv2_2<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu2_2 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu2_1<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> max_pool<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu2_2<span class="token punctuation">)</span>

    n<span class="token punctuation">.</span>conv3_1<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu3_1 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>pool2<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>conv3_2<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu3_2 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu3_1<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>conv3_3<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu3_3 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu3_2<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>pool3 <span class="token operator">=</span> max_pool<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu3_3<span class="token punctuation">)</span>

    n<span class="token punctuation">.</span>conv4_1<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu4_1 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>pool3<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>conv4_2<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu4_2 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu4_1<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>conv4_3<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu4_3 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu4_2<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>pool4 <span class="token operator">=</span> max_pool<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu4_3<span class="token punctuation">)</span>

    n<span class="token punctuation">.</span>conv5_1<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu5_1 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>pool4<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>conv5_2<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu5_2 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu5_1<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>conv5_3<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu5_3 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu5_2<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>pool5 <span class="token operator">=</span> max_pool<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu5_3<span class="token punctuation">)</span>

    <span class="token comment"># fully conv</span>
    n<span class="token punctuation">.</span>fc6<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu6 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>pool5<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> ks<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>drop6 <span class="token operator">=</span> L<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu6<span class="token punctuation">,</span> dropout_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> in_place<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>fc7<span class="token punctuation">,</span> n<span class="token punctuation">.</span>relu7 <span class="token operator">=</span> conv_relu<span class="token punctuation">(</span>n<span class="token punctuation">.</span>drop6<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> ks<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>drop7 <span class="token operator">=</span> L<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>n<span class="token punctuation">.</span>relu7<span class="token punctuation">,</span> dropout_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> in_place<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>score_fr <span class="token operator">=</span> L<span class="token punctuation">.</span>Convolution<span class="token punctuation">(</span>n<span class="token punctuation">.</span>drop7<span class="token punctuation">,</span> num_output<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        param<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> decay_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> decay_mult<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>upscore2 <span class="token operator">=</span> L<span class="token punctuation">.</span>Deconvolution<span class="token punctuation">(</span>n<span class="token punctuation">.</span>score_fr<span class="token punctuation">,</span>
        convolution_param<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>num_output<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
            bias_term<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        param<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    n<span class="token punctuation">.</span>score_pool4 <span class="token operator">=</span> L<span class="token punctuation">.</span>Convolution<span class="token punctuation">(</span>n<span class="token punctuation">.</span>pool4<span class="token punctuation">,</span> num_output<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        param<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> decay_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> decay_mult<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>score_pool4c <span class="token operator">=</span> crop<span class="token punctuation">(</span>n<span class="token punctuation">.</span>score_pool4<span class="token punctuation">,</span> n<span class="token punctuation">.</span>upscore2<span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>fuse_pool4 <span class="token operator">=</span> L<span class="token punctuation">.</span>Eltwise<span class="token punctuation">(</span>n<span class="token punctuation">.</span>upscore2<span class="token punctuation">,</span> n<span class="token punctuation">.</span>score_pool4c<span class="token punctuation">,</span>
            operation<span class="token operator">=</span>P<span class="token punctuation">.</span>Eltwise<span class="token punctuation">.</span>SUM<span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>upscore_pool4 <span class="token operator">=</span> L<span class="token punctuation">.</span>Deconvolution<span class="token punctuation">(</span>n<span class="token punctuation">.</span>fuse_pool4<span class="token punctuation">,</span>
        convolution_param<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>num_output<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
            bias_term<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        param<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    n<span class="token punctuation">.</span>score_pool3 <span class="token operator">=</span> L<span class="token punctuation">.</span>Convolution<span class="token punctuation">(</span>n<span class="token punctuation">.</span>pool3<span class="token punctuation">,</span> num_output<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        param<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> decay_mult<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> decay_mult<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>score_pool3c <span class="token operator">=</span> crop<span class="token punctuation">(</span>n<span class="token punctuation">.</span>score_pool3<span class="token punctuation">,</span> n<span class="token punctuation">.</span>upscore_pool4<span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>fuse_pool3 <span class="token operator">=</span> L<span class="token punctuation">.</span>Eltwise<span class="token punctuation">(</span>n<span class="token punctuation">.</span>upscore_pool4<span class="token punctuation">,</span> n<span class="token punctuation">.</span>score_pool3c<span class="token punctuation">,</span>
            operation<span class="token operator">=</span>P<span class="token punctuation">.</span>Eltwise<span class="token punctuation">.</span>SUM<span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>upscore8 <span class="token operator">=</span> L<span class="token punctuation">.</span>Deconvolution<span class="token punctuation">(</span>n<span class="token punctuation">.</span>fuse_pool3<span class="token punctuation">,</span>
        convolution_param<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>num_output<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>
            bias_term<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        param<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">(</span>lr_mult<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    n<span class="token punctuation">.</span>score <span class="token operator">=</span> crop<span class="token punctuation">(</span>n<span class="token punctuation">.</span>upscore8<span class="token punctuation">,</span> n<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    n<span class="token punctuation">.</span>loss <span class="token operator">=</span> L<span class="token punctuation">.</span>SoftmaxWithLoss<span class="token punctuation">(</span>n<span class="token punctuation">.</span>score<span class="token punctuation">,</span> n<span class="token punctuation">.</span>label<span class="token punctuation">,</span>
            loss_param<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>normalize<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> ignore_label<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> n<span class="token punctuation">.</span>to_proto<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">make_net</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'train.prototxt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>fcn<span class="token punctuation">(</span><span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'val.prototxt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>fcn<span class="token punctuation">(</span><span class="token string">'seg11valid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    make_net<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="fcn8-vgg"><a href="#fcn8-vgg" class="headerlink" title="fcn8_vgg"></a>fcn8_vgg</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> absolute_import
<span class="token keyword">from</span> __future__ <span class="token keyword">import</span> division
<span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function

<span class="token keyword">import</span> os
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> math <span class="token keyword">import</span> ceil
<span class="token keyword">import</span> sys

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

VGG_MEAN <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">103.939</span><span class="token punctuation">,</span> <span class="token number">116.779</span><span class="token punctuation">,</span> <span class="token number">123.68</span><span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">FCN8VGG</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vgg16_npy_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> vgg16_npy_path <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            path <span class="token operator">=</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__module__<span class="token punctuation">]</span><span class="token punctuation">.</span>__file__
            <span class="token comment"># print path</span>
            path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> os<span class="token punctuation">.</span>pardir<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># print path</span>
            path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"vgg16.npy"</span><span class="token punctuation">)</span>
            vgg16_npy_path <span class="token operator">=</span> path
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Load npy file from '%s'."</span><span class="token punctuation">,</span> vgg16_npy_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>vgg16_npy_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"File '%s' not found. Download it from "</span>
                           <span class="token string">"ftp://mi.eng.cam.ac.uk/pub/mttt2/"</span>
                           <span class="token string">"models/vgg16.npy"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vgg16_npy_path<span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>data_dict <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>vgg16_npy_path<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'latin1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wd <span class="token operator">=</span> <span class="token number">5e-4</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"npy file loaded"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">build</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rgb<span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> random_init_fc8<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
              debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> use_dilated<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Build the VGG model using loaded weights
        Parameters
        ----------
        rgb: image batch tensor
            Image in rgb shap. Scaled to Intervall [0, 255]
        train: bool
            Whether to build train or inference graph
        num_classes: int
            How many classes should be predicted (by fc8)
        random_init_fc8 : bool
            Whether to initialize fc8 layer randomly.
            Finetuning is required in this case.
        debug: bool
            Whether to print additional Debug Information.
        """</span>
        <span class="token comment"># Convert RGB to BGR</span>

        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'Processing'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

            red<span class="token punctuation">,</span> green<span class="token punctuation">,</span> blue <span class="token operator">=</span> tf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>rgb<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token comment"># assert red.get_shape().as_list()[1:] == [224, 224, 1]</span>
            <span class="token comment"># assert green.get_shape().as_list()[1:] == [224, 224, 1]</span>
            <span class="token comment"># assert blue.get_shape().as_list()[1:] == [224, 224, 1]</span>
            bgr <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>
                blue <span class="token operator">-</span> VGG_MEAN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                green <span class="token operator">-</span> VGG_MEAN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                red <span class="token operator">-</span> VGG_MEAN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> debug<span class="token punctuation">:</span>
                bgr <span class="token operator">=</span> tf<span class="token punctuation">.</span>Print<span class="token punctuation">(</span>bgr<span class="token punctuation">,</span> <span class="token punctuation">[</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>bgr<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               message<span class="token operator">=</span><span class="token string">'Shape of input image: '</span><span class="token punctuation">,</span>
                               summarize<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> first_n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>bgr<span class="token punctuation">,</span> <span class="token string">"conv1_1"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1_1<span class="token punctuation">,</span> <span class="token string">"conv1_2"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool1 <span class="token operator">=</span> self<span class="token punctuation">.</span>_max_pool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1_2<span class="token punctuation">,</span> <span class="token string">'pool1'</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool1<span class="token punctuation">,</span> <span class="token string">"conv2_1"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2_1<span class="token punctuation">,</span> <span class="token string">"conv2_2"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_max_pool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2_2<span class="token punctuation">,</span> <span class="token string">'pool2'</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool2<span class="token punctuation">,</span> <span class="token string">"conv3_1"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv3_1<span class="token punctuation">,</span> <span class="token string">"conv3_2"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_3 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv3_2<span class="token punctuation">,</span> <span class="token string">"conv3_3"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool3 <span class="token operator">=</span> self<span class="token punctuation">.</span>_max_pool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv3_3<span class="token punctuation">,</span> <span class="token string">'pool3'</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool3<span class="token punctuation">,</span> <span class="token string">"conv4_1"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv4_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv4_1<span class="token punctuation">,</span> <span class="token string">"conv4_2"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv4_3 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv4_2<span class="token punctuation">,</span> <span class="token string">"conv4_3"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> use_dilated<span class="token punctuation">:</span>
            pad <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>pool4 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv4_3<span class="token punctuation">,</span> ksize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                        strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                        padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'pool4'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>pool4 <span class="token operator">=</span> tf<span class="token punctuation">.</span>space_to_batch<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool4<span class="token punctuation">,</span>
                                           paddings<span class="token operator">=</span>pad<span class="token punctuation">,</span> block_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pool4 <span class="token operator">=</span> self<span class="token punctuation">.</span>_max_pool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv4_3<span class="token punctuation">,</span> <span class="token string">'pool4'</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool4<span class="token punctuation">,</span> <span class="token string">"conv5_1"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5_1<span class="token punctuation">,</span> <span class="token string">"conv5_2"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5_3 <span class="token operator">=</span> self<span class="token punctuation">.</span>_conv_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5_2<span class="token punctuation">,</span> <span class="token string">"conv5_3"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> use_dilated<span class="token punctuation">:</span>
            pad <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>pool5 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5_3<span class="token punctuation">,</span> ksize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                        strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                        padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'pool5'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>pool5 <span class="token operator">=</span> tf<span class="token punctuation">.</span>space_to_batch<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool5<span class="token punctuation">,</span>
                                           paddings<span class="token operator">=</span>pad<span class="token punctuation">,</span> block_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pool5 <span class="token operator">=</span> self<span class="token punctuation">.</span>_max_pool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5_3<span class="token punctuation">,</span> <span class="token string">'pool5'</span><span class="token punctuation">,</span> debug<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>fc6 <span class="token operator">=</span> self<span class="token punctuation">.</span>_fc_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool5<span class="token punctuation">,</span> <span class="token string">"fc6"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> train<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>fc6 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc6<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>fc7 <span class="token operator">=</span> self<span class="token punctuation">.</span>_fc_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc6<span class="token punctuation">,</span> <span class="token string">"fc7"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> train<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>fc7 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc7<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> use_dilated<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pool5 <span class="token operator">=</span> tf<span class="token punctuation">.</span>batch_to_space<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool5<span class="token punctuation">,</span> crops<span class="token operator">=</span>pad<span class="token punctuation">,</span> block_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>pool5 <span class="token operator">=</span> tf<span class="token punctuation">.</span>batch_to_space<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool5<span class="token punctuation">,</span> crops<span class="token operator">=</span>pad<span class="token punctuation">,</span> block_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>fc7 <span class="token operator">=</span> tf<span class="token punctuation">.</span>batch_to_space<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc7<span class="token punctuation">,</span> crops<span class="token operator">=</span>pad<span class="token punctuation">,</span> block_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>fc7 <span class="token operator">=</span> tf<span class="token punctuation">.</span>batch_to_space<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc7<span class="token punctuation">,</span> crops<span class="token operator">=</span>pad<span class="token punctuation">,</span> block_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>

        <span class="token keyword">if</span> random_init_fc8<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>score_fr <span class="token operator">=</span> self<span class="token punctuation">.</span>_score_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc7<span class="token punctuation">,</span> <span class="token string">"score_fr"</span><span class="token punctuation">,</span>
                                              num_classes<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>score_fr <span class="token operator">=</span> self<span class="token punctuation">.</span>_fc_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc7<span class="token punctuation">,</span> <span class="token string">"score_fr"</span><span class="token punctuation">,</span>
                                           num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>
                                           relu<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>pred <span class="token operator">=</span> tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>self<span class="token punctuation">.</span>score_fr<span class="token punctuation">,</span> dimension<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>upscore2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_upscore_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>score_fr<span class="token punctuation">,</span>
                                            shape<span class="token operator">=</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool4<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>
                                            debug<span class="token operator">=</span>debug<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'upscore2'</span><span class="token punctuation">,</span>
                                            ksize<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score_pool4 <span class="token operator">=</span> self<span class="token punctuation">.</span>_score_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool4<span class="token punctuation">,</span> <span class="token string">"score_pool4"</span><span class="token punctuation">,</span>
                                             num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fuse_pool4 <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>self<span class="token punctuation">.</span>upscore2<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score_pool4<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>upscore4 <span class="token operator">=</span> self<span class="token punctuation">.</span>_upscore_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fuse_pool4<span class="token punctuation">,</span>
                                            shape<span class="token operator">=</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool3<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>
                                            debug<span class="token operator">=</span>debug<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'upscore4'</span><span class="token punctuation">,</span>
                                            ksize<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score_pool3 <span class="token operator">=</span> self<span class="token punctuation">.</span>_score_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pool3<span class="token punctuation">,</span> <span class="token string">"score_pool3"</span><span class="token punctuation">,</span>
                                             num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fuse_pool3 <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>self<span class="token punctuation">.</span>upscore4<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score_pool3<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>upscore32 <span class="token operator">=</span> self<span class="token punctuation">.</span>_upscore_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fuse_pool3<span class="token punctuation">,</span>
                                             shape<span class="token operator">=</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>bgr<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                             num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>
                                             debug<span class="token operator">=</span>debug<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'upscore32'</span><span class="token punctuation">,</span>
                                             ksize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>pred_up <span class="token operator">=</span> tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>self<span class="token punctuation">.</span>upscore32<span class="token punctuation">,</span> dimension<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_max_pool</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> name<span class="token punctuation">,</span> debug<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pool <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> ksize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token punctuation">)</span>

        <span class="token keyword">if</span> debug<span class="token punctuation">:</span>
            pool <span class="token operator">=</span> tf<span class="token punctuation">.</span>Print<span class="token punctuation">(</span>pool<span class="token punctuation">,</span> <span class="token punctuation">[</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            message<span class="token operator">=</span><span class="token string">'Shape of %s'</span> <span class="token operator">%</span> name<span class="token punctuation">,</span>
                            summarize<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> first_n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> pool

    <span class="token keyword">def</span> <span class="token function">_conv_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
            filt <span class="token operator">=</span> self<span class="token punctuation">.</span>get_conv_filter<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> filt<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>

            conv_biases <span class="token operator">=</span> self<span class="token punctuation">.</span>get_bias<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            bias <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span> conv_biases<span class="token punctuation">)</span>

            relu <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>bias<span class="token punctuation">)</span>
            <span class="token comment"># Add summary to Tensorboard</span>
            _activation_summary<span class="token punctuation">(</span>relu<span class="token punctuation">)</span>
            <span class="token keyword">return</span> relu

    <span class="token keyword">def</span> <span class="token function">_fc_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> name<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                  relu<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
            shape <span class="token operator">=</span> bottom<span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_list<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">'fc6'</span><span class="token punctuation">:</span>
                filt <span class="token operator">=</span> self<span class="token punctuation">.</span>get_fc_weight_reshape<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> name <span class="token operator">==</span> <span class="token string">'score_fr'</span><span class="token punctuation">:</span>
                name <span class="token operator">=</span> <span class="token string">'fc8'</span>  <span class="token comment"># Name of score_fr layer in VGG Model</span>
                filt <span class="token operator">=</span> self<span class="token punctuation">.</span>get_fc_weight_reshape<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                  num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                filt <span class="token operator">=</span> self<span class="token punctuation">.</span>get_fc_weight_reshape<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>_add_wd_and_summary<span class="token punctuation">(</span>filt<span class="token punctuation">,</span> self<span class="token punctuation">.</span>wd<span class="token punctuation">,</span> <span class="token string">"fc_wlosses"</span><span class="token punctuation">)</span>

            conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> filt<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>
            conv_biases <span class="token operator">=</span> self<span class="token punctuation">.</span>get_bias<span class="token punctuation">(</span>name<span class="token punctuation">,</span> num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
            bias <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span> conv_biases<span class="token punctuation">)</span>

            <span class="token keyword">if</span> relu<span class="token punctuation">:</span>
                bias <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>bias<span class="token punctuation">)</span>
            _activation_summary<span class="token punctuation">(</span>bias<span class="token punctuation">)</span>

            <span class="token keyword">if</span> debug<span class="token punctuation">:</span>
                bias <span class="token operator">=</span> tf<span class="token punctuation">.</span>Print<span class="token punctuation">(</span>bias<span class="token punctuation">,</span> <span class="token punctuation">[</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>bias<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                message<span class="token operator">=</span><span class="token string">'Shape of %s'</span> <span class="token operator">%</span> name<span class="token punctuation">,</span>
                                summarize<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> first_n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> bias

    <span class="token keyword">def</span> <span class="token function">_score_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> name<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
            <span class="token comment"># get number of input channels</span>
            in_features <span class="token operator">=</span> bottom<span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value
            shape <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> in_features<span class="token punctuation">,</span> num_classes<span class="token punctuation">]</span>
            <span class="token comment"># He initialization Sheme</span>
            <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">"score_fr"</span><span class="token punctuation">:</span>
                num_input <span class="token operator">=</span> in_features
                stddev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">/</span> num_input<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0.5</span>
            <span class="token keyword">elif</span> name <span class="token operator">==</span> <span class="token string">"score_pool4"</span><span class="token punctuation">:</span>
                stddev <span class="token operator">=</span> <span class="token number">0.001</span>
            <span class="token keyword">elif</span> name <span class="token operator">==</span> <span class="token string">"score_pool3"</span><span class="token punctuation">:</span>
                stddev <span class="token operator">=</span> <span class="token number">0.0001</span>
            <span class="token comment"># Apply convolution</span>
            w_decay <span class="token operator">=</span> self<span class="token punctuation">.</span>wd

            weights <span class="token operator">=</span> self<span class="token punctuation">.</span>_variable_with_weight_decay<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> stddev<span class="token punctuation">,</span> w_decay<span class="token punctuation">,</span>
                                                       decoder<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>
            <span class="token comment"># Apply bias</span>
            conv_biases <span class="token operator">=</span> self<span class="token punctuation">.</span>_bias_variable<span class="token punctuation">(</span><span class="token punctuation">[</span>num_classes<span class="token punctuation">]</span><span class="token punctuation">,</span> constant<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span>
            bias <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span> conv_biases<span class="token punctuation">)</span>

            _activation_summary<span class="token punctuation">(</span>bias<span class="token punctuation">)</span>

            <span class="token keyword">return</span> bias

    <span class="token keyword">def</span> <span class="token function">_upscore_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> shape<span class="token punctuation">,</span>
                       num_classes<span class="token punctuation">,</span> name<span class="token punctuation">,</span> debug<span class="token punctuation">,</span>
                       ksize<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        strides <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
            in_features <span class="token operator">=</span> bottom<span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value

            <span class="token keyword">if</span> shape <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># Compute shape out of Bottom</span>
                in_shape <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>bottom<span class="token punctuation">)</span>

                h <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>in_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
                w <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>in_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
                new_shape <span class="token operator">=</span> <span class="token punctuation">[</span>in_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> num_classes<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                new_shape <span class="token operator">=</span> <span class="token punctuation">[</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">]</span>
            output_shape <span class="token operator">=</span> tf<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>new_shape<span class="token punctuation">)</span>

            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"Layer: %s, Fan-in: %d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> in_features<span class="token punctuation">)</span><span class="token punctuation">)</span>
            f_shape <span class="token operator">=</span> <span class="token punctuation">[</span>ksize<span class="token punctuation">,</span> ksize<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> in_features<span class="token punctuation">]</span>

            <span class="token comment"># create</span>
            num_input <span class="token operator">=</span> ksize <span class="token operator">*</span> ksize <span class="token operator">*</span> in_features <span class="token operator">/</span> stride
            stddev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">/</span> num_input<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0.5</span>

            weights <span class="token operator">=</span> self<span class="token punctuation">.</span>get_deconv_filter<span class="token punctuation">(</span>f_shape<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_add_wd_and_summary<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> self<span class="token punctuation">.</span>wd<span class="token punctuation">,</span> <span class="token string">"fc_wlosses"</span><span class="token punctuation">)</span>
            deconv <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d_transpose<span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> output_shape<span class="token punctuation">,</span>
                                            strides<span class="token operator">=</span>strides<span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> debug<span class="token punctuation">:</span>
                deconv <span class="token operator">=</span> tf<span class="token punctuation">.</span>Print<span class="token punctuation">(</span>deconv<span class="token punctuation">,</span> <span class="token punctuation">[</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>deconv<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  message<span class="token operator">=</span><span class="token string">'Shape of %s'</span> <span class="token operator">%</span> name<span class="token punctuation">,</span>
                                  summarize<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> first_n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        _activation_summary<span class="token punctuation">(</span>deconv<span class="token punctuation">)</span>
        <span class="token keyword">return</span> deconv

    <span class="token keyword">def</span> <span class="token function">get_deconv_filter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
        width <span class="token operator">=</span> f_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        height <span class="token operator">=</span> f_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        f <span class="token operator">=</span> ceil<span class="token punctuation">(</span>width<span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">)</span>
        c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> f <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> f<span class="token punctuation">)</span>
        bilinear <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>f_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> f_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">:</span>
                value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>x <span class="token operator">/</span> f <span class="token operator">-</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>y <span class="token operator">/</span> f <span class="token operator">-</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                bilinear<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> value
        weights <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>f_shape<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>f_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            weights<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> bilinear

        init <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span>value<span class="token operator">=</span>weights<span class="token punctuation">,</span>
                                       dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        var <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"up_filter"</span><span class="token punctuation">,</span> initializer<span class="token operator">=</span>init<span class="token punctuation">,</span>
                              shape<span class="token operator">=</span>weights<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">return</span> var

    <span class="token keyword">def</span> <span class="token function">get_conv_filter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        init <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span>value<span class="token operator">=</span>self<span class="token punctuation">.</span>data_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                       dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        shape <span class="token operator">=</span> self<span class="token punctuation">.</span>data_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Layer name: %s'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Layer shape: %s'</span> <span class="token operator">%</span> <span class="token builtin">str</span><span class="token punctuation">(</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
        var <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"filter"</span><span class="token punctuation">,</span> initializer<span class="token operator">=</span>init<span class="token punctuation">,</span> shape<span class="token operator">=</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> tf<span class="token punctuation">.</span>get_variable_scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reuse<span class="token punctuation">:</span>
            weight_decay <span class="token operator">=</span> tf<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>l2_loss<span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>wd<span class="token punctuation">,</span>
                                       name<span class="token operator">=</span><span class="token string">'weight_loss'</span><span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>add_to_collection<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>GraphKeys<span class="token punctuation">.</span>REGULARIZATION_LOSSES<span class="token punctuation">,</span>
                                 weight_decay<span class="token punctuation">)</span>
        _variable_summaries<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
        <span class="token keyword">return</span> var

    <span class="token keyword">def</span> <span class="token function">get_bias</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        bias_wights <span class="token operator">=</span> self<span class="token punctuation">.</span>data_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        shape <span class="token operator">=</span> self<span class="token punctuation">.</span>data_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape
        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">'fc8'</span><span class="token punctuation">:</span>
            bias_wights <span class="token operator">=</span> self<span class="token punctuation">.</span>_bias_reshape<span class="token punctuation">(</span>bias_wights<span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                             num_classes<span class="token punctuation">)</span>
            shape <span class="token operator">=</span> <span class="token punctuation">[</span>num_classes<span class="token punctuation">]</span>
        init <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span>value<span class="token operator">=</span>bias_wights<span class="token punctuation">,</span>
                                       dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        var <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"biases"</span><span class="token punctuation">,</span> initializer<span class="token operator">=</span>init<span class="token punctuation">,</span> shape<span class="token operator">=</span>shape<span class="token punctuation">)</span>
        _variable_summaries<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
        <span class="token keyword">return</span> var

    <span class="token keyword">def</span> <span class="token function">get_fc_weight</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        init <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span>value<span class="token operator">=</span>self<span class="token punctuation">.</span>data_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                       dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        shape <span class="token operator">=</span> self<span class="token punctuation">.</span>data_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape
        var <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"weights"</span><span class="token punctuation">,</span> initializer<span class="token operator">=</span>init<span class="token punctuation">,</span> shape<span class="token operator">=</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> tf<span class="token punctuation">.</span>get_variable_scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reuse<span class="token punctuation">:</span>
            weight_decay <span class="token operator">=</span> tf<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>l2_loss<span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>wd<span class="token punctuation">,</span>
                                       name<span class="token operator">=</span><span class="token string">'weight_loss'</span><span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>add_to_collection<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>GraphKeys<span class="token punctuation">.</span>REGULARIZATION_LOSSES<span class="token punctuation">,</span>
                                 weight_decay<span class="token punctuation">)</span>
        _variable_summaries<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
        <span class="token keyword">return</span> var

    <span class="token keyword">def</span> <span class="token function">_bias_reshape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bweight<span class="token punctuation">,</span> num_orig<span class="token punctuation">,</span> num_new<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" Build bias weights for filter produces with `_summary_reshape`

        """</span>
        n_averaged_elements <span class="token operator">=</span> num_orig<span class="token operator">//</span>num_new
        avg_bweight <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>num_new<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> num_orig<span class="token punctuation">,</span> n_averaged_elements<span class="token punctuation">)</span><span class="token punctuation">:</span>
            start_idx <span class="token operator">=</span> i
            end_idx <span class="token operator">=</span> start_idx <span class="token operator">+</span> n_averaged_elements
            avg_idx <span class="token operator">=</span> start_idx<span class="token operator">//</span>n_averaged_elements
            <span class="token keyword">if</span> avg_idx <span class="token operator">==</span> num_new<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            avg_bweight<span class="token punctuation">[</span>avg_idx<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>bweight<span class="token punctuation">[</span>start_idx<span class="token punctuation">:</span>end_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> avg_bweight

    <span class="token keyword">def</span> <span class="token function">_summary_reshape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fweight<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> num_new<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" Produce weights for a reduced fully-connected layer.

        FC8 of VGG produces 1000 classes. Most semantic segmentation
        task require much less classes. This reshapes the original weights
        to be used in a fully-convolutional layer which produces num_new
        classes. To archive this the average (mean) of n adjanced classes is
        taken.

        Consider reordering fweight, to perserve semantic meaning of the
        weights.

        Args:
          fweight: original weights
          shape: shape of the desired fully-convolutional layer
          num_new: number of new classes


        Returns:
          Filter weights for `num_new` classes.
        """</span>
        num_orig <span class="token operator">=</span> shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> num_new
        <span class="token keyword">assert</span><span class="token punctuation">(</span>num_new <span class="token operator">&lt;</span> num_orig<span class="token punctuation">)</span>
        n_averaged_elements <span class="token operator">=</span> num_orig<span class="token operator">//</span>num_new
        avg_fweight <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> num_orig<span class="token punctuation">,</span> n_averaged_elements<span class="token punctuation">)</span><span class="token punctuation">:</span>
            start_idx <span class="token operator">=</span> i
            end_idx <span class="token operator">=</span> start_idx <span class="token operator">+</span> n_averaged_elements
            avg_idx <span class="token operator">=</span> start_idx<span class="token operator">//</span>n_averaged_elements
            <span class="token keyword">if</span> avg_idx <span class="token operator">==</span> num_new<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            avg_fweight<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> avg_idx<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>
                fweight<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> start_idx<span class="token punctuation">:</span>end_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> avg_fweight

    <span class="token keyword">def</span> <span class="token function">_variable_with_weight_decay</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> stddev<span class="token punctuation">,</span> wd<span class="token punctuation">,</span> decoder<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Helper to create an initialized Variable with weight decay.

        Note that the Variable is initialized with a truncated normal
        distribution.
        A weight decay is added only if one is specified.

        Args:
          name: name of the variable
          shape: list of ints
          stddev: standard deviation of a truncated Gaussian
          wd: add L2Loss weight decay multiplied by this float. If None, weight
              decay is not added for this Variable.

        Returns:
          Variable Tensor
        """</span>

        initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span>stddev<span class="token punctuation">)</span>
        var <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span>shape<span class="token punctuation">,</span>
                              initializer<span class="token operator">=</span>initializer<span class="token punctuation">)</span>

        collection_name <span class="token operator">=</span> tf<span class="token punctuation">.</span>GraphKeys<span class="token punctuation">.</span>REGULARIZATION_LOSSES
        <span class="token keyword">if</span> wd <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token keyword">not</span> tf<span class="token punctuation">.</span>get_variable_scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reuse<span class="token punctuation">)</span><span class="token punctuation">:</span>
            weight_decay <span class="token operator">=</span> tf<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span>
                tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>l2_loss<span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">,</span> wd<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'weight_loss'</span><span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>add_to_collection<span class="token punctuation">(</span>collection_name<span class="token punctuation">,</span> weight_decay<span class="token punctuation">)</span>
        _variable_summaries<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
        <span class="token keyword">return</span> var

    <span class="token keyword">def</span> <span class="token function">_add_wd_and_summary</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> var<span class="token punctuation">,</span> wd<span class="token punctuation">,</span> collection_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> collection_name <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            collection_name <span class="token operator">=</span> tf<span class="token punctuation">.</span>GraphKeys<span class="token punctuation">.</span>REGULARIZATION_LOSSES
        <span class="token keyword">if</span> wd <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token keyword">not</span> tf<span class="token punctuation">.</span>get_variable_scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reuse<span class="token punctuation">)</span><span class="token punctuation">:</span>
            weight_decay <span class="token operator">=</span> tf<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span>
                tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>l2_loss<span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">,</span> wd<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'weight_loss'</span><span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>add_to_collection<span class="token punctuation">(</span>collection_name<span class="token punctuation">,</span> weight_decay<span class="token punctuation">)</span>
        _variable_summaries<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
        <span class="token keyword">return</span> var

    <span class="token keyword">def</span> <span class="token function">_bias_variable</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> constant<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span>constant<span class="token punctuation">)</span>
        var <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'biases'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span>shape<span class="token punctuation">,</span>
                              initializer<span class="token operator">=</span>initializer<span class="token punctuation">)</span>
        _variable_summaries<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
        <span class="token keyword">return</span> var

    <span class="token keyword">def</span> <span class="token function">get_fc_weight_reshape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Layer name: %s'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Layer shape: %s'</span> <span class="token operator">%</span> shape<span class="token punctuation">)</span>
        weights <span class="token operator">=</span> self<span class="token punctuation">.</span>data_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        weights <span class="token operator">=</span> weights<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">if</span> num_classes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            weights <span class="token operator">=</span> self<span class="token punctuation">.</span>_summary_reshape<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> shape<span class="token punctuation">,</span>
                                            num_new<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        init <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span>value<span class="token operator">=</span>weights<span class="token punctuation">,</span>
                                       dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        var <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"weights"</span><span class="token punctuation">,</span> initializer<span class="token operator">=</span>init<span class="token punctuation">,</span> shape<span class="token operator">=</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">return</span> var


<span class="token keyword">def</span> <span class="token function">_activation_summary</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Helper to create summaries for activations.

    Creates a summary that provides a histogram of activations.
    Creates a summary that measure the sparsity of activations.

    Args:
      x: Tensor
    Returns:
      nothing
    """</span>
    <span class="token comment"># Remove 'tower_[0-9]/' from the name in case this is a multi-GPU training</span>
    <span class="token comment"># session. This helps the clarity of presentation on tensorboard.</span>
    tensor_name <span class="token operator">=</span> x<span class="token punctuation">.</span>op<span class="token punctuation">.</span>name
    <span class="token comment"># tensor_name = re.sub('%s_[0-9]*/' % TOWER_NAME, '', x.op.name)</span>
    tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>tensor_name <span class="token operator">+</span> <span class="token string">'/activations'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>tensor_name <span class="token operator">+</span> <span class="token string">'/sparsity'</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>zero_fraction<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">_variable_summaries</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Attach a lot of summaries to a Tensor."""</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> tf<span class="token punctuation">.</span>get_variable_scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reuse<span class="token punctuation">:</span>
        name <span class="token operator">=</span> var<span class="token punctuation">.</span>op<span class="token punctuation">.</span>name
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Creating Summary for: %s"</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'summaries'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            mean <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">'/mean'</span><span class="token punctuation">,</span> mean<span class="token punctuation">)</span>
            <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'stddev'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                stddev <span class="token operator">=</span> tf<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>var <span class="token operator">-</span> mean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">'/sttdev'</span><span class="token punctuation">,</span> stddev<span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">'/max'</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>reduce_max<span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">'/min'</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>reduce_min<span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span>
            tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>name<span class="token punctuation">,</span> var<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="fcn-调包"><a href="#fcn-调包" class="headerlink" title="fcn 调包"></a>fcn 调包</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> abc <span class="token keyword">import</span> ABCMeta
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models


<span class="token keyword">def</span> <span class="token function">_maybe_pad</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hpad <span class="token operator">=</span> size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    wpad <span class="token operator">=</span> size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> hpad <span class="token operator">+</span> wpad <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> wpad<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> hpad<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> x


<span class="token keyword">class</span> <span class="token class-name">VGGFCN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> n_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> in_channels <span class="token operator">==</span> <span class="token number">3</span>
        self<span class="token punctuation">.</span>n_classes <span class="token operator">=</span> n_classes
        self<span class="token punctuation">.</span>vgg16 <span class="token operator">=</span> models<span class="token punctuation">.</span>vgg16<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> n_classes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_initialize_weights<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_initialize_weights</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>classifier<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>vgg16<span class="token punctuation">.</span>classifier<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>view<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>classifier<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>classifier<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>vgg16<span class="token punctuation">.</span>classifier<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>view<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>classifier<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">VGGFCN32</span><span class="token punctuation">(</span>VGGFCN<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        input_height<span class="token punctuation">,</span> input_width <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>vgg16<span class="token punctuation">.</span>features<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>x<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>input_height<span class="token punctuation">,</span> input_width<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x


<span class="token keyword">class</span> <span class="token class-name">VGGFCN16</span><span class="token punctuation">(</span>VGGFCN<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> n_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> n_classes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> n_classes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>upscale5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>
            n_classes<span class="token punctuation">,</span> n_classes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        input_height<span class="token punctuation">,</span> input_width <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        pool4 <span class="token operator">=</span> self<span class="token punctuation">.</span>vgg16<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        pool5 <span class="token operator">=</span> self<span class="token punctuation">.</span>vgg16<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">(</span>pool4<span class="token punctuation">)</span>
        pool5_upscaled <span class="token operator">=</span> self<span class="token punctuation">.</span>upscale5<span class="token punctuation">(</span>self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>pool5<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pool4 <span class="token operator">=</span> self<span class="token punctuation">.</span>score4<span class="token punctuation">(</span>pool4<span class="token punctuation">)</span>
        x <span class="token operator">=</span> pool4 <span class="token operator">+</span> pool5_upscaled
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>x<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>input_height<span class="token punctuation">,</span> input_width<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x


<span class="token keyword">class</span> <span class="token class-name">VGGFCN8</span><span class="token punctuation">(</span>VGGFCN<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> n_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> n_classes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>upscale4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>
            n_classes<span class="token punctuation">,</span> n_classes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            <span class="token number">512</span><span class="token punctuation">,</span> n_classes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            <span class="token number">256</span><span class="token punctuation">,</span> n_classes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>upscale5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>
            n_classes<span class="token punctuation">,</span> n_classes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        input_height<span class="token punctuation">,</span> input_width <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        pool3 <span class="token operator">=</span> self<span class="token punctuation">.</span>vgg16<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        pool4 <span class="token operator">=</span> self<span class="token punctuation">.</span>vgg16<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">(</span>pool3<span class="token punctuation">)</span>
        pool5 <span class="token operator">=</span> self<span class="token punctuation">.</span>vgg16<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">(</span>pool4<span class="token punctuation">)</span>
        pool5_upscaled <span class="token operator">=</span> self<span class="token punctuation">.</span>upscale5<span class="token punctuation">(</span>self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>pool5<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pool5_upscaled <span class="token operator">=</span> _maybe_pad<span class="token punctuation">(</span>pool5_upscaled<span class="token punctuation">,</span> pool4<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        pool4_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>score4<span class="token punctuation">(</span>pool4<span class="token punctuation">)</span>
        pool4_fused <span class="token operator">=</span> pool4_scores <span class="token operator">+</span> pool5_upscaled
        pool4_upscaled <span class="token operator">=</span> self<span class="token punctuation">.</span>upscale4<span class="token punctuation">(</span>pool4_fused<span class="token punctuation">)</span>
        pool4_upscaled <span class="token operator">=</span> _maybe_pad<span class="token punctuation">(</span>pool4_upscaled<span class="token punctuation">,</span> pool3<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>score3<span class="token punctuation">(</span>pool3<span class="token punctuation">)</span> <span class="token operator">+</span> pool4_upscaled
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>x<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>input_height<span class="token punctuation">,</span> input_width<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h4><h3 id="U-Net"><a href="#U-Net" class="headerlink" title="U-Net"></a><strong>U-Net</strong></h3><ul>
<li><strong>优点</strong>：简单易用，适用于小数据集，尤其在医学图像分割中表现良好。</li>
<li><strong>缺点</strong>：容易过拟合，不太适合大规模数据集。</li>
</ul>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740236677445SwkUbDFUtolVEKxc4dmcbrOknJf.png" alt="1740236677445SwkUbDFUtolVEKxc4dmcbrOknJf.png"></p>
<h4 id="提出初衷-1"><a href="#提出初衷-1" class="headerlink" title="提出初衷"></a>提出初衷</h4><p>U-Net 是一种经典且广泛使用的分割模型，以其简单、高效、易于理解和构建的特点而受到青睐，尤其适合从小数据集中进行训练。该模型最早于 2015 年在论文《U-Net: Convolutional Networks for Biomedical Image Segmentation》中被提出，至今仍然是医学图像分割领域的重要基础模型。</p>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740236700448YM2HbihrkonVkixR0KdcPLcBnLc.png" alt="1740236700448YM2HbihrkonVkixR0KdcPLcBnLc.png"></p>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740236696443Voorb6LuJopG3exmtulcaySynjc.png" alt="1740236696443Voorb6LuJopG3exmtulcaySynjc.png"></p>
<p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740236682500NfPrbS5SNoEjsFxFFptcl471nhb.png" alt="1740236682500NfPrbS5SNoEjsFxFFptcl471nhb.png"></p>
<ol>
<li>Unet 提出的初衷是为了解决医学图像分割的问题；</li>
<li>一种 U 型的网络结构来获取上下文的信息和位置信息；</li>
<li>在 2015 年的 ISBI cell tracking 比赛中获得了多个第一，一开始这是为了解决细胞层面的分割的任务的</li>
</ol>
<h4 id="网络结构-1"><a href="#网络结构-1" class="headerlink" title="网络结构"></a>网络结构</h4><p><img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/1740236655458N3Vab29uNorFHwxpINwc5s6unkh.png" alt="1740236655458N3Vab29uNorFHwxpINwc5s6unkh.png"></p>
<p>U-Net 网络是一种经典的编码器-解码器结构，因其整体结构形似大写的英文字母“U”而得名。它广泛应用于医学图像分割等领域。U-Net 的设计非常简洁：前半部分用于特征提取（编码器），后半部分用于上采样（解码器）。</p>
<h5 id="编码器（Encoder）"><a href="#编码器（Encoder）" class="headerlink" title="编码器（Encoder）"></a>编码器（Encoder）</h5><p>编码器位于网络的左半部分，主要由多个下采样模块组成。每个模块包含两个 3×3 的卷积层（激活函数为 ReLU），后接一个 2×2 的最大池化（Max Pooling）层，用于特征提取和空间尺寸的减半。通过这种结构，编码器能够逐步提取图像的深层特征，同时扩大感受野。</p>
<h5 id="解码器（Decoder）"><a href="#解码器（Decoder）" class="headerlink" title="解码器（Decoder）"></a>解码器（Decoder）</h5><p>解码器位于网络的右半部分，主要由上采样模块组成。每个模块包含一个 2×2 的反卷积层（上采样卷积层），用于将特征图的空间尺寸恢复到与编码器对应层相同的大小。随后，解码器通过特征拼接（concatenation）将上采样后的特征图与编码器中对应层的特征图进行通道级拼接，最后通过两个 3×3 的卷积层（激活函数为 ReLU）进一步融合特征。这种结构能够有效地结合深层特征和浅层特征，兼顾全局语义信息和局部细节。</p>
<h5 id="特征融合方式"><a href="#特征融合方式" class="headerlink" title="特征融合方式"></a>特征融合方式</h5><p>与 FCN 网络通过特征图对应像素值的相加来融合特征不同，U-Net 采用通道级拼接的方式。这种方式可以形成更厚的特征图，从而保留更多的细节信息，但也增加了显存的消耗。</p>
<h3 id="U-Net-的优点"><a href="#U-Net-的优点" class="headerlink" title="U-Net 的优点"></a>U-Net 的优点</h3><ol>
<li><strong>多尺度特征融合</strong>：U-Net 通过拼接深层和浅层特征图，能够充分利用不同层次的特征。浅层卷积关注纹理和细节特征，而深层网络关注更高级的语义特征。这种融合方式使得模型能够更好地处理复杂的分割任务。</li>
<li><strong>边缘特征的保留</strong>：在下采样过程中，虽然会损失一些边缘特征，但通过特征拼接，解码器能够从编码器的浅层特征中找回这些丢失的边缘信息，从而提高分割的精度。</li>
</ol>
<p>Unet 的好处我感觉是：网络层越深得到的特征图，有着更大的视野域，浅层卷积关注纹理特征，深层网络关注本质的那种特征，所以深层浅层特征都是有格子的意义的；另外一点是通过反卷积得到的更大的尺寸的特征图的边缘，是缺少信息的，毕竟每一次下采样提炼特征的同时，也必然会损失一些边缘特征，而失去的特征并不能从上采样中找回，因此通过特征的拼接，来实现边缘特征的一个找回。</p>
<p>下面是一些与医学相关的数据集以及对应的提取码,有兴趣的同学可以下载下来跑一下。</p>
<table>
<tr>
<td>**数据集名称**<br></td><td>**下载链接**<td>**提取码**<br></td></td></tr>
<tr>
<td>Cell dataset (dsb2018)<br></td><td>https://pan.baidu.com/share/init?surl=BaVrzYdrSP78CwYaRzZr1w<td>5l54<br></td></td></tr>
<tr>
<td>Liver dataset<br></td><td>https://pan.baidu.com/share/init?surl=FljGCVzu7HPYpwAKvSVN4Q<td>5l88<br></td></td></tr>
<tr>
<td>Cell dataset (isbi)<br></td><td>https://pan.baidu.com/share/init?surl=FkfnhU-RnYFZti62-f8AVA<td>14rz<br></td></td></tr>
<tr>
<td>Lung dataset<br></td><td>https://pan.baidu.com/share/init?surl=sLFRmtG2TOTEgUKniJf7AA<td>qdwo<br></td></td></tr>
<tr>
<td>Corneal Nerve dataset<br></td><td>https://pan.baidu.com/share/init?surl=T3-kS_FgYI6DeXv3n1I7bA<td>ih02<br></td></td></tr>
<tr>
<td>Eye Vessels (DRIVE dataset)<br></td><td>https://pan.baidu.com/share/init?surl=UkMLmdbM61N8ecgnKlAsPg<td>f1ek<br></td></td></tr>
<tr>
<td>Esophagus and Esophagus Cancer dataset (First Affiliated Hospital of Sun Yat-sen University)<br></td><td>https://pan.baidu.com/share/init?surl=0b5arIQjNpiggwdkgYNHXQ<td>hivm<br></td></td></tr>
</table>

<h4 id="为什么-Unet-在医疗图像分割中表现好"><a href="#为什么-Unet-在医疗图像分割中表现好" class="headerlink" title="为什么 Unet 在医疗图像分割中表现好?"></a>为什么 Unet 在医疗图像分割中表现好?</h4><p>大多数医疗影像语义分割任务都会首先用 Unet 作为 baseline，当然上一章节讲解的 Unet 的优点肯定是可以当作这个问题的答案，这里谈一谈医疗影像的特点</p>
<p>根据网友的讨论，得到的结果：</p>
<ol>
<li>医疗影像语义较为简单、结构固定。因此语义信息相比自动驾驶等较为单一，因此并不需要去筛选过滤无用的信息。医疗影像的所有特征都很重要，因此低级特征和高级语义特征都很重要，所以 U 型结构的 skip connection 结构（特征拼接）更好派上用场</li>
<li>医学影像的数据较少，获取难度大，数据量可能只有几百甚至不到 100，因此如果使用大型的网络例如 DeepLabv3+ 等模型，很容易过拟合。大型网络的优点是更强的图像表述能力，而较为简单、数量少的医学影像并没有那么多的内容需要表述，因此也有人发现在小数量级中，分割的 SOTA 模型与轻量的 Unet 并没有神恶魔优势</li>
<li>医学影像往往是多模态的。比方说 ISLES 脑梗竞赛中，官方提供了 CBF，MTT，CBV 等多中模态的数据（这一点听不懂也无妨）。因此医学影像任务中，往往需要自己设计网络去提取不同的模态特征，因此轻量结构简单的 Unet 可以有更大的操作空间。</li>
</ol>
<blockquote>
<p>Q:过拟合与模型复杂程度有关还和什么有关呢?</p>
</blockquote>
<h4 id="模型代码-1"><a href="#模型代码-1" class="headerlink" title="模型代码"></a>模型代码</h4><h5 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> autograd
<span class="token keyword">from</span> functools <span class="token keyword">import</span> partial
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> models

<span class="token keyword">class</span> <span class="token class-name">DoubleConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_ch<span class="token punctuation">,</span> out_ch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DoubleConv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span> out_ch<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> _padding_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_ch<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>_inplace_<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>out_ch<span class="token punctuation">,</span> out_ch<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> _padding_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_ch<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>_inplace_<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv<span class="token operator">**</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Unet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_ch<span class="token punctuation">,</span> out_ch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Unet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span><span class="token operator">**</span>conv1<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>pool1<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv2<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>pool2<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv3<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>pool3<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv4<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>pool4<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv5<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>up6<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> _stride_<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv6<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>up7<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> _stride_<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv7<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>up8<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> _stride_<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv8<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>up9<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> _stride_<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv9<span class="token operator">**</span> <span class="token operator">=</span> DoubleConv<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>conv10<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> out_ch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _<span class="token comment">#print(x.shape)_</span>
        c1 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv1<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        p1 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>pool1<span class="token operator">**</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
        _<span class="token comment">#print(p1.shape)_</span>
        c2 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv2<span class="token operator">**</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
        p2 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>pool2<span class="token operator">**</span><span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
        _<span class="token comment">#print(p2.shape)_</span>
        c3 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv3<span class="token operator">**</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span>
        p3 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>pool3<span class="token operator">**</span><span class="token punctuation">(</span>c3<span class="token punctuation">)</span>
        _<span class="token comment">#print(p3.shape)_</span>
        c4 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv4<span class="token operator">**</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span>
        p4 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>pool4<span class="token operator">**</span><span class="token punctuation">(</span>c4<span class="token punctuation">)</span>
        _<span class="token comment">#print(p4.shape)_</span>
        c5 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv5<span class="token operator">**</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span>
        up_6 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>up6<span class="token operator">**</span><span class="token punctuation">(</span>c5<span class="token punctuation">)</span>
        merge6 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>up_6<span class="token punctuation">,</span> c4<span class="token punctuation">]</span><span class="token punctuation">,</span> _dim_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        c6 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv6<span class="token operator">**</span><span class="token punctuation">(</span>merge6<span class="token punctuation">)</span>
        up_7 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>up7<span class="token operator">**</span><span class="token punctuation">(</span>c6<span class="token punctuation">)</span>
        merge7 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>up_7<span class="token punctuation">,</span> c3<span class="token punctuation">]</span><span class="token punctuation">,</span> _dim_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        c7 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv7<span class="token operator">**</span><span class="token punctuation">(</span>merge7<span class="token punctuation">)</span>
        up_8 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>up8<span class="token operator">**</span><span class="token punctuation">(</span>c7<span class="token punctuation">)</span>
        merge8 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>up_8<span class="token punctuation">,</span> c2<span class="token punctuation">]</span><span class="token punctuation">,</span> _dim_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        c8 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv8<span class="token operator">**</span><span class="token punctuation">(</span>merge8<span class="token punctuation">)</span>
        up_9 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>up9<span class="token operator">**</span><span class="token punctuation">(</span>c8<span class="token punctuation">)</span>
        merge9 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>up_9<span class="token punctuation">,</span> c1<span class="token punctuation">]</span><span class="token punctuation">,</span> _dim_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        c9 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv9<span class="token operator">**</span><span class="token punctuation">(</span>merge9<span class="token punctuation">)</span>
        c10 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv10<span class="token operator">**</span><span class="token punctuation">(</span>c9<span class="token punctuation">)</span>
        out <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>c10<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out

nonlinearity <span class="token operator">=</span> partial<span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">,</span> _inplace_<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">DecoderBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> n_filters<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DecoderBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span><span class="token operator">**</span>conv1<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> in_channels <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>norm1<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>in_channels <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>relu1<span class="token operator">**</span> <span class="token operator">=</span> nonlinearity

        self<span class="token punctuation">.</span><span class="token operator">**</span>deconv2<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>in_channels <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> in_channels <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> _stride_<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> _padding_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> _output_padding_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>norm2<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>in_channels <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>relu2<span class="token operator">**</span> <span class="token operator">=</span> nonlinearity

        self<span class="token punctuation">.</span><span class="token operator">**</span>conv3<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> n_filters<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>norm3<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>n_filters<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>relu3<span class="token operator">**</span> <span class="token operator">=</span> nonlinearity

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv1<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>norm1<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>relu1<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>deconv2<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>norm2<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>relu2<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>conv3<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>norm3<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>relu3<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x

<span class="token keyword">class</span> <span class="token class-name">resnet34_unet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>resnet34_unet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        filters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span>
        resnet <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet34<span class="token punctuation">(</span>_pretrained_<span class="token operator">=</span>pretrained<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>firstconv<span class="token operator">**</span> <span class="token operator">=</span> resnet<span class="token punctuation">.</span><span class="token operator">**</span>conv1<span class="token operator">**</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>firstbn<span class="token operator">**</span> <span class="token operator">=</span> resnet<span class="token punctuation">.</span><span class="token operator">**</span>bn1<span class="token operator">**</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>firstrelu<span class="token operator">**</span> <span class="token operator">=</span> resnet<span class="token punctuation">.</span><span class="token operator">**</span>relu<span class="token operator">**</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>firstmaxpool<span class="token operator">**</span> <span class="token operator">=</span> resnet<span class="token punctuation">.</span><span class="token operator">**</span>maxpool<span class="token operator">**</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>encoder1<span class="token operator">**</span> <span class="token operator">=</span> resnet<span class="token punctuation">.</span><span class="token operator">**</span>layer1<span class="token operator">**</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>encoder2<span class="token operator">**</span> <span class="token operator">=</span> resnet<span class="token punctuation">.</span><span class="token operator">**</span>layer2<span class="token operator">**</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>encoder3<span class="token operator">**</span> <span class="token operator">=</span> resnet<span class="token punctuation">.</span><span class="token operator">**</span>layer3<span class="token operator">**</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>encoder4<span class="token operator">**</span> <span class="token operator">=</span> resnet<span class="token punctuation">.</span><span class="token operator">**</span>layer4<span class="token operator">**</span>

        self<span class="token punctuation">.</span><span class="token operator">**</span>decoder4<span class="token operator">**</span> <span class="token operator">=</span> DecoderBlock<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> filters<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>decoder3<span class="token operator">**</span> <span class="token operator">=</span> DecoderBlock<span class="token punctuation">(</span>filters<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>decoder2<span class="token operator">**</span> <span class="token operator">=</span> DecoderBlock<span class="token punctuation">(</span>filters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>decoder1<span class="token operator">**</span> <span class="token operator">=</span> DecoderBlock<span class="token punctuation">(</span>filters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span><span class="token operator">**</span>decoder4<span class="token operator">**</span> <span class="token operator">=</span> DecoderBlock<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> filters<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>decoder3<span class="token operator">**</span> <span class="token operator">=</span> DecoderBlock<span class="token punctuation">(</span>filters<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>decoder2<span class="token operator">**</span> <span class="token operator">=</span> DecoderBlock<span class="token punctuation">(</span>filters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>decoder1<span class="token operator">**</span> <span class="token operator">=</span> DecoderBlock<span class="token punctuation">(</span>filters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span><span class="token operator">**</span>finaldeconv1<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>filters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>finalrelu1<span class="token operator">**</span> <span class="token operator">=</span> nonlinearity
        self<span class="token punctuation">.</span><span class="token operator">**</span>finalconv2<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> _padding_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token operator">**</span>finalrelu2<span class="token operator">**</span> <span class="token operator">=</span> nonlinearity
        self<span class="token punctuation">.</span><span class="token operator">**</span>finalconv3<span class="token operator">**</span> <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> _padding_<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _<span class="token comment"># Encoder_</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>firstconv<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>firstbn<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>firstrelu<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>firstmaxpool<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        e1 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>encoder1<span class="token operator">**</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        e2 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>encoder2<span class="token operator">**</span><span class="token punctuation">(</span>e1<span class="token punctuation">)</span>
        e3 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>encoder3<span class="token operator">**</span><span class="token punctuation">(</span>e2<span class="token punctuation">)</span>
        e4 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>encoder4<span class="token operator">**</span><span class="token punctuation">(</span>e3<span class="token punctuation">)</span>

        _<span class="token comment"># Center_</span>

        _<span class="token comment"># Decoder_</span>
        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>decoder4<span class="token operator">**</span><span class="token punctuation">(</span>e4<span class="token punctuation">)</span> <span class="token operator">+</span> e3
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>decoder3<span class="token operator">**</span><span class="token punctuation">(</span>d4<span class="token punctuation">)</span> <span class="token operator">+</span> e2
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>decoder2<span class="token operator">**</span><span class="token punctuation">(</span>d3<span class="token punctuation">)</span> <span class="token operator">+</span> e1
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>decoder1<span class="token operator">**</span><span class="token punctuation">(</span>d2<span class="token punctuation">)</span>

        out <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>finaldeconv1<span class="token operator">**</span><span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>finalrelu1<span class="token operator">**</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>finalconv2<span class="token operator">**</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>finalrelu2<span class="token operator">**</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token operator">**</span>finalconv3<span class="token operator">**</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="模型实现"><a href="#模型实现" class="headerlink" title="模型实现"></a>模型实现</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">double_conv2d_bn</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>double_conv2d_bn<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">,</span>
                               kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span>
                              stride <span class="token operator">=</span> strides<span class="token punctuation">,</span>padding<span class="token operator">=</span>padding<span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">,</span>
                              kernel_size <span class="token operator">=</span> kernel_size<span class="token punctuation">,</span>
                              stride <span class="token operator">=</span> strides<span class="token punctuation">,</span>padding<span class="token operator">=</span>padding<span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span>
  
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        out <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
  
<span class="token keyword">class</span> <span class="token class-name">deconv2d_bn</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>deconv2d_bn<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">,</span>
                                        kernel_size <span class="token operator">=</span> kernel_size<span class="token punctuation">,</span>
                                       stride <span class="token operator">=</span> strides<span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span>
      
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        out <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
  
<span class="token keyword">class</span> <span class="token class-name">Unet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Unet<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer1_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer2_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer3_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer4_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer5_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer6_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer7_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer8_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer9_conv <span class="token operator">=</span> double_conv2d_bn<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer10_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                                     stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
      
        self<span class="token punctuation">.</span>deconv1 <span class="token operator">=</span> deconv2d_bn<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>deconv2 <span class="token operator">=</span> deconv2d_bn<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>deconv3 <span class="token operator">=</span> deconv2d_bn<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>deconv4 <span class="token operator">=</span> deconv2d_bn<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span>
      
        self<span class="token punctuation">.</span>sigmoid <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
      
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        conv1 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer1_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        pool1 <span class="token operator">=</span> F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>conv1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
      
        conv2 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer2_conv<span class="token punctuation">(</span>pool1<span class="token punctuation">)</span>
        pool2 <span class="token operator">=</span> F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>conv2<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
      
        conv3 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer3_conv<span class="token punctuation">(</span>pool2<span class="token punctuation">)</span>
        pool3 <span class="token operator">=</span> F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>conv3<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
      
        conv4 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer4_conv<span class="token punctuation">(</span>pool3<span class="token punctuation">)</span>
        pool4 <span class="token operator">=</span> F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>conv4<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
      
        conv5 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer5_conv<span class="token punctuation">(</span>pool4<span class="token punctuation">)</span>
      
        convt1 <span class="token operator">=</span> self<span class="token punctuation">.</span>deconv1<span class="token punctuation">(</span>conv5<span class="token punctuation">)</span>
        concat1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>convt1<span class="token punctuation">,</span>conv4<span class="token punctuation">]</span><span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        conv6 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer6_conv<span class="token punctuation">(</span>concat1<span class="token punctuation">)</span>
      
        convt2 <span class="token operator">=</span> self<span class="token punctuation">.</span>deconv2<span class="token punctuation">(</span>conv6<span class="token punctuation">)</span>
        concat2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>convt2<span class="token punctuation">,</span>conv3<span class="token punctuation">]</span><span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        conv7 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer7_conv<span class="token punctuation">(</span>concat2<span class="token punctuation">)</span>
      
        convt3 <span class="token operator">=</span> self<span class="token punctuation">.</span>deconv3<span class="token punctuation">(</span>conv7<span class="token punctuation">)</span>
        concat3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>convt3<span class="token punctuation">,</span>conv2<span class="token punctuation">]</span><span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        conv8 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer8_conv<span class="token punctuation">(</span>concat3<span class="token punctuation">)</span>
      
        convt4 <span class="token operator">=</span> self<span class="token punctuation">.</span>deconv4<span class="token punctuation">(</span>conv8<span class="token punctuation">)</span>
        concat4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>convt4<span class="token punctuation">,</span>conv1<span class="token punctuation">]</span><span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        conv9 <span class="token operator">=</span> self<span class="token punctuation">.</span>layer9_conv<span class="token punctuation">(</span>concat4<span class="token punctuation">)</span>
        outp <span class="token operator">=</span> self<span class="token punctuation">.</span>layer10_conv<span class="token punctuation">(</span>conv9<span class="token punctuation">)</span>
        outp <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>outp<span class="token punctuation">)</span>
        <span class="token keyword">return</span> outp
  

model <span class="token operator">=</span> Unet<span class="token punctuation">(</span><span class="token punctuation">)</span>
inp <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">)</span>
outp <span class="token operator">=</span> model<span class="token punctuation">(</span>inp<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>outp<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="相关资源-1"><a href="#相关资源-1" class="headerlink" title="相关资源"></a>相关资源</h4><h5 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h5><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Andy-zhujunwen/UNET-ZOO?tab=readme-ov-file%60">https://github.com/Andy-zhujunwen/UNET-ZOO?tab=readme-ov-file`</a><br><code> https://github.com/bigmb/Unet-Segmentation-Pytorch-Nest-of-Unets</code><br><code> https://www.codewithgpu.com/i/bubbliiiing/unet-pytorch/UNet-PyTorch</code><br>`<br><a target="_blank" rel="noopener" href="https://huggingface.co/spaces/h2chen/demo_unet">https://huggingface.co/spaces/h2chen/demo_unet</a></p>
</blockquote>
<h5 id="博客"><a href="#博客" class="headerlink" title="博客"></a>博客</h5><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45074568/article/details/114901600">UNet详解（附图文和代码实现）-CSDN博客</a><code>&lt;br&gt;</code><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/PythonLearner/p/14041874.html">图像分割必备知识点 | Unet详解 理论+ 代码 - 忽逢桃林 - 博客园</a></p>
</blockquote>
<hr>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/2025/02/16/2025-02-16-%E5%AE%9E%E4%BE%8B%E5%88%86%E5%89%B2/">实例分割</a></li>
                
                
                    <li>下一篇: <a href="/2025/02/11/2025-02-11-%E6%95%B0%E6%A8%A1%E7%AC%94%E8%AE%B0_%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%B8%8E%E5%B7%AE%E5%88%86%E6%96%B9%E7%A8%8B/">2025-02-11-数模笔记_微分方程与差分方程</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/deep-learning/" rel="tag">深度学习</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://tk-pichost-1325224430.cos.ap-chengdu.myqcloud.com/blog/20250927100251272.jpg?imageSlim" alt="ttkqwe" />
            </figure>
        
            <div class="author-info">
                <h4>ttkqwe</h4>
                <p>计算机大三学生，喜欢研究一些乱七八糟的东西，目前研究方向是深度学习。本站未注明转载的文章均为原创，并采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow">CC BY-NC-SA 4.0</a> 授权协议，<span style="color: #E91E63">转载请注明来源</span>，谢谢！</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <button class="to-top" href="#"></button>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/10/15/2025-10-15-python%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%BC%8F%E4%B8%8Emap%E5%87%BD%E6%95%B0/">2025-10-15-python列表推导式与map函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/10/14/2025-10-14-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AE%9E%E9%AA%8C%E4%BA%8C-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95%EF%BC%88Telnet%EF%BC%89/">2025-10-14-计算机网络实验二-交换机基本配置与远程登录（Telnet）</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/07/29/2025-07-29-%E4%B9%9D%E6%A0%BC%E9%80%9A%E7%94%A8%E5%9F%BA%E7%A1%80%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">2025-07-29-九格通用基础大模型环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/07/03/2025-07-03-%E6%8B%AF%E6%95%91%E6%88%91%E7%9A%84%E2%80%9C%E9%AB%98%E7%83%A7%E2%80%9D%E6%88%98%E5%8F%8B%E2%80%94%E2%80%94Y7000P%202024%E7%89%88%E6%B8%85%E7%81%B0%E6%8D%A2%E7%A1%85%E8%84%82%E8%AE%B0%E5%BD%95/">2025-07-03-拯救我的“高烧”战友——Y7000P 2024 版清灰换硅脂记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/08/2025-06-08-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%95%E5%B1%82%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">2025-06-08-大模型底层技术分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/05/2025-06-05-%E6%99%BA%E8%83%BD%E4%BD%93%E5%B9%B3%E5%8F%B0%E5%8F%8A%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">2025-06-05-智能体平台及关键技术分析</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">十月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">七月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">六月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">五月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">四月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">三月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">二月 2025</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/mathematical-modeling/" style="font-size: 10px;">数学建模</a> <a href="/tags/deep-learning/" style="font-size: 14px;">深度学习</a> <a href="/tags/development/" style="font-size: 18px;">程序开发</a> <a href="/tags/algorithm/" style="font-size: 10px;">算法学习</a> <a href="/tags/algorithm-practice/" style="font-size: 16px;">算法练习</a> <a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size: 12px;">论文阅读</a> <a href="/tags/course/" style="font-size: 20px;">课程学习</a> <a href="/tags/troubleshooting/" style="font-size: 18px;">问题解决</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>
                © 2025 <a href="/">TK的小站</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.
                
                    &nbsp;|&nbsp;
                    <a href="https://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
                        蜀ICP备2025165253号
                    </a>
                
                
                    &nbsp;|&nbsp;
                    <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11000002000001" target="_blank" rel="nofollow noopener" class="police-beian">
                        <span class="police-icon" aria-hidden="true"></span>
                        <span class="police-text">京公网安备11000002000001号</span>
                    </a>
                
            </p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":true,"night":true});</script>

<style>
.police-beian{display:inline-flex;align-items:center;gap:4px}
.police-icon{display:inline-block;width:16px;height:16px;background:#e91e63;border-radius:2px;opacity:.85}
/* 说明：如需官方警徽图标，可将 .police-icon 的 background 设置为图片：
   background:url('https://www.beian.gov.cn/img/ghs.png') no-repeat center/contain; */
</style>

  </body>
</html>
